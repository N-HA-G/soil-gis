<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>åœŸå£Œè¨ºæ–­çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --c-brand:#0a66c2; --c-text:#333; --c-sub:#555; --c-muted:#888;
      --c-border:#eee; --c-bg:#fff; --c-ok:#4caf50; --c-warn:#ffb300; --c-bad:#e53935;
      --shadow:0 2px 8px rgba(0,0,0,.06); --radius:12px;
    }
    html,body{margin:0;padding:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif; line-height:1.7; padding:16px; max-width:1100px; margin:0 auto; color:var(--c-text); background:#f7f7f8;}
    a{color:var(--c-brand); text-decoration:none;} a:hover{text-decoration:underline;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap;}
    .pill{display:inline-flex; align-items:center; gap:6px; background:#f1f3f5; border-radius:999px; padding:2px 10px; font-size:12px; color:var(--c-sub);}
    .btn{border:1px solid #ddd; background:#fafafa; padding:6px 10px; border-radius:8px; cursor:pointer;}
    .btn:hover{background:#f0f0f0;} .btn.primary{border-color:var(--c-brand); background:var(--c-brand); color:#fff;}
    .badge{display:inline-block; color:#fff; padding:4px 12px; border-radius:6px; margin-right:6px; font-weight:700; font-size:13px;}
    .muted{color:var(--c-muted);}
    .card{background:var(--c-bg); border:1px solid var(--c-border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);}
    .card h2{font-size:16px; margin:0 0 10px;}
    .grid{display:grid; grid-template-columns:1.3fr 1fr; gap:14px;}
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }
    .kpi{display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;}
    @media (max-width: 900px){ .kpi{ grid-template-columns:1fr 1fr 1fr; } }
    .k{background:#f9f9fb; border:1px solid #f0f0f0; border-radius:10px; padding:10px;}
    .k label{display:block; font-size:12px; color:var(--c-sub);} .k b{font-size:20px;}
    .charts{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
    @media (max-width: 900px){ .charts{ grid-template-columns:1fr; } }
    .eval-table{width:100%; border-collapse:collapse;}
    .eval-table th,.eval-table td{border-bottom:1px solid var(--c-border); padding:6px 8px; text-align:left;}
    .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff;}
    .chip.ok{background:var(--c-ok);} .chip.warn{background:var(--c-warn); color:#000;} .chip.bad{background:var(--c-bad);}
    .gallery{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media (max-width: 900px){ .gallery{ grid-template-columns:repeat(2, 1fr);} }
    .gallery img{width:100%; height:180px; object-fit:cover; border-radius:8px; border:1px solid var(--c-border); box-shadow:var(--shadow); background:#fff;}
    .warn{background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:10px;}
    .sources{font-size:12px; color:var(--c-muted);}
    .summary-top{background:#fff; border-left:5px solid var(--c-brand); padding:10px 12px; border-radius:8px; box-shadow:var(--shadow);}
  </style>
</head>
<body>

  <!-- Top -->
  <div class="topbar">
    <div class="row">
      <a href="./index.html">â† åœ°å›³ã¸æˆ»ã‚‹</a>
      <span class="pill" id="idPill"></span>
      <span class="pill" id="srcPill"></span>
    </div>
    <div class="row">
      <label>ç”¨é€”</label>
      <select id="landuse">
        <option value="paddy">æ°´ç”°</option>
        <option value="upland">ç•‘</option>
      </select>
      <button class="btn" id="prevBtn">â† å‰ã¸</button>
      <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      <button class="btn" id="copyLinkBtn">ğŸ”— ã‚³ãƒ”ãƒ¼</button>
      <button class="btn" id="editToggle">ç·¨é›†</button>
      <button class="btn primary" id="saveBtn" style="display:none;">ä¿å­˜</button>
    </div>
  </div>

  <!-- æœ€çµ‚åœ°ç‚¹ã®èª¬æ˜ï¼ˆæœ€ä¸Šéƒ¨ã«å¤§ããï¼‰ -->
  <div id="summaryTop" class="summary-top" style="display:none; margin-bottom:12px;"></div>

  <!-- Title -->
  <h1 id="fieldName" style="margin:6px 0;"></h1>
  <div id="location" class="muted"></div>

  <!-- Badges -->
  <div style="margin-top:10px;">
    <span class="badge" id="rankBadge"></span>
    <span class="badge" style="background:var(--c-ok);">soil_pointså‚ç…§</span>
  </div>

  <!-- One-linerï¼ˆè‡ªå‹•ï¼‰ -->
  <p id="oneLine" style="font-weight:700; margin-top:10px;"></p>

  <!-- KPIs + Tools -->
  <div class="card">
    <h2>ä¸»è¦æŒ‡æ¨™</h2>
    <div class="kpi">
      <div class="k"><label>EC</label><b id="kEC">-</b></div>
      <div class="k"><label>pH</label><b id="kpH">-</b></div>
      <div class="k"><label>CEC</label><b id="kCEC">-</b></div>
      <div class="k"><label>C/Næ¯”</label><b id="kCN">-</b></div>
      <div class="k"><label>å¾®ç”Ÿç‰©å¤šæ§˜æ€§</label><b id="kBio">-</b></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btn" id="copyCoordBtn">ğŸ“ åº§æ¨™ã‚³ãƒ”ãƒ¼</button>
      <button class="btn" id="downloadJsonBtn">â¬‡ JSON</button>
      <button class="btn" id="downloadCsvBtn">â¬‡ CSV</button>
    </div>
  </div>

  <!-- Charts + Memo -->
  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h2>ãƒãƒ£ãƒ¼ãƒˆ</h2>
      <div class="charts">
        <canvas id="radarChart" height="260"></canvas>
        <canvas id="barChart" height="260"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>ãƒ¡ãƒ¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</h2>
      <div id="memoView">
        <div><b>å›ºå®šèª¬æ˜ï¼š</b><span id="fixedDescView"></span></div>
        <div><b>è©•ä¾¡ï¼š</b><span id="evalView"></span></div>
        <div><b>ä¸»ãªèª²é¡Œï¼š</b><span id="issueView"></span></div>
        <div><b>æ”¹å–„ç­–ï¼š</b><span id="solutionView"></span></div>
      </div>

      <div id="memoEdit" style="display:none; margin-top:10px;">
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">å›ºå®šèª¬æ˜</div>
          <input type="text" id="fixedDescInput" placeholder="ä¾‹ï¼šåœ°å½¢ãƒ»åœŸåœ°åˆ©ç”¨ã®èª¬æ˜ãªã©">
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">è©•ä¾¡</div>
          <input type="text" id="evalInput" placeholder="ä¾‹ï¼šè‰¯ / æ™®é€š / è¦æ”¹å–„ ãªã©">
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">ä¸»ãªèª²é¡Œ</div>
          <textarea id="issueInput" rows="3" placeholder="ä¸»ãªèª²é¡Œã‚’è¨˜å…¥"></textarea>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:4px;">æ”¹å–„ç­–</div>
          <textarea id="solutionInput" rows="3" placeholder="æ”¹å–„ç­–ã‚’è¨˜å…¥"></textarea>
        </div>
      </div>
      <small class="muted">â€» ãƒ¡ãƒ¢ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨IDã§ç´ã¥ã‘ï¼‰</small>
    </div>
  </div>

  <!-- Evaluation tableï¼ˆå¼•ç”¨åŸºæº–ä»˜ãï¼‰ -->
  <div class="card" style="margin-top:12px;">
    <h2>æ¨™æº–å€¤ã¨ã®æ¯”è¼ƒï¼ˆç”¨é€”ã”ã¨ã®åŸºæº–ã‚’å¼•ç”¨ï¼‰</h2>
    <table class="eval-table" id="evalTable">
      <thead>
        <tr><th>é …ç›®</th><th>å€¤</th><th>æ¨™æº–ï¼ˆç›®å®‰ï¼‰</th><th>åˆ¤å®š</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="sources" id="sourcesBox" style="margin-top:8px;"></div>
  </div>

  <!-- ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ -->
  <div class="card" style="margin-top:12px;">
    <h2>ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆimage/ï¼‰</h2>
    <div id="gallery" class="gallery"></div>
    <div id="galleryNote" class="muted" style="margin-top:6px;"></div>
  </div>

  <!-- å…¨å±æ€§ -->
  <details>
    <summary>ğŸ”¬ soil_points ã®å±æ€§ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰</summary>
    <div id="analysisWrap"></div>
  </details>

  <script>
    /**********************
     * ä¾¿åˆ©é–¢æ•°
     **********************/
    const $ = id => document.getElementById(id);
    const num = x => { const n = Number(x); return Number.isFinite(n) ? n : NaN; };
    const fmt = (v, d=2) => Number.isFinite(v) ? v.toFixed(d) : "â€”";
    async function copyText(text){ try{ await navigator.clipboard.writeText(text); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); } catch{ prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:", text); } }
    function renderPropsTable(props){
      const table = document.createElement("table"); table.className="meta";
      Object.entries(props||{}).forEach(([k,v])=>{
        const tr=document.createElement("tr"); const th=document.createElement("th"); const td=document.createElement("td");
        th.textContent=k; td.textContent=(v==null?"":String(v)); tr.append(th,td); table.append(tr);
      }); return table;
    }
    function jsonToCsv(obj){
      const keys=Object.keys(obj); const vals=keys.map(k=>'"'+String(obj[k]??"").replace(/"/g,'""')+'"');
      return keys.join(",")+"\n"+vals.join(",")+"\n";
    }
    function downloadBlob(name, text, type="text/plain"){
      const blob=new Blob([text], {type}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    }

    /**********************
     * URL ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
     **********************/
    const params = new URLSearchParams(location.search);
    const pointId = params.get("id");
    const src = params.get("src") || "data/Saitama/Chichibu/Oota/soil_points.geojson";
    $("idPill").textContent  = `ID: ${pointId ?? "-"}`;
    $("srcPill").textContent = `src: ${src}`;

    /**********************
     * çŠ¶æ…‹
     **********************/
    let featureList = []; let currentIndex = -1;
    let radarChart = null, barChart = null;
    let STANDARDS = null; let SOURCES = []; let STD_MAP = null;
    const LU_KEY = "soil_landuse:"+src;

    /**********************
     * ãƒ¡ã‚¤ãƒ³
     **********************/
    main();
    async function main(){
      if(!pointId){ document.body.innerHTML = `<div class="warn">IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¾‹ï¼š<code>soil.html?id=F001&src=...</code></div>`; return; }

      // åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
      try{
        const stdRes = await fetch("data/standard_data/standards.json", {cache:"no-store"});
        if (stdRes.ok) {
          const j = await stdRes.json();
          STANDARDS = j;
          SOURCES = Array.isArray(j.sources) ? j.sources : [];
          const savedLU = localStorage.getItem(LU_KEY) || j?.meta?.default_landuse || "paddy";
          $("landuse").value = savedLU;
        } else {
          STANDARDS = null;
        }
      }catch{ STANDARDS = null; }

      // soil_points ã‚’ãƒ­ãƒ¼ãƒ‰
      let fc;
      try{
        const res = await fetch(src, {cache:"no-store"});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        fc = await res.json();
      }catch(e){
        document.body.innerHTML = `<div class="warn">soil_points ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼š<code>${src}</code><br>ã‚¨ãƒ©ãƒ¼ï¼š<code>${String(e)}</code></div>`;
        return;
      }

      featureList = Array.isArray(fc.features) ? fc.features : [];
      currentIndex = featureList.findIndex(f => String(f?.properties?.field_id) === String(pointId));
      if(currentIndex < 0){
        document.body.innerHTML = `<div class="warn">ID <code>${pointId}</code> ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆsrc=${src}ï¼‰ã€‚</div>`;
        return;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆ
      $("prevBtn").onclick = () => {
        if (currentIndex <= 0) return;
        const fid = featureList[currentIndex-1].properties?.field_id;
        location.href = `soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
      };
      $("nextBtn").onclick = () => {
        if (currentIndex >= featureList.length-1) return;
        const fid = featureList[currentIndex+1].properties?.field_id;
        location.href = `soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
      };
      $("copyLinkBtn").onclick = () => copyText(location.href);

      $("landuse").onchange = () => {
        localStorage.setItem(LU_KEY, $("landuse").value);
        render(featureList[currentIndex]); // å†è©•ä¾¡
      };

      render(featureList[currentIndex]);
    }

    /**********************
     * è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯
     **********************/
    function getStd(){
      const lu = $("landuse").value || STANDARDS?.meta?.default_landuse || "paddy";
      return STANDARDS?.standards?.[lu] || null;
    }
    function addRow(tbody, label, v, stdText, judge){
      const tr=document.createElement("tr");
      const td1=document.createElement("td"); td1.textContent=label;
      const td2=document.createElement("td"); td2.textContent=(v ?? "â€”");
      const td3=document.createElement("td"); td3.textContent=stdText || "â€”";
      const td4=document.createElement("td"); const chip=document.createElement("span"); chip.className="chip "+(judge.class||""); chip.textContent=judge.label; td4.appendChild(chip);
      const td5=document.createElement("td"); td5.textContent=judge.comment||"";
      tr.append(td1,td2,td3,td4,td5); tbody.appendChild(tr);
    }
    function judgeRange(value, std, type){
      if (!Number.isFinite(value)) return {label:"â€”", class:"", comment:"å€¤ãªã—"};
      if (!std) return {label:"â€”", class:"", comment:"åŸºæº–ãªã—"};
      if (type==="ph"){
        const ok = std.ok||[5.5,6.5], warn=std.warn||[5.0,7.5];
        if (value>=ok[0] && value<=ok[1]) return {label:"è‰¯", class:"ok", comment:"é©æ­£åŸŸå†…"};
        if ((value>=warn[0] && value<ok[0]) || (value>ok[1] && value<=warn[1])) return {label:"æ³¨æ„", class:"warn", comment:"ã‚„ã‚„å¤–ã‚Œã€‚çŸ¯æ­£è³‡æç­‰ã‚’æ¤œè¨"};
        return {label:"è¦æ”¹å–„", class:"bad", comment:"é©æ­£åŸŸå¤–ã€‚çŸ¯æ­£ãƒ»æ–½è‚¥è¨­è¨ˆã®è¦‹ç›´ã—"};
      }
      if (type==="ec"){
        const okMax = std.ok_max ?? 0.5, warnMax = std.warn_max ?? 0.8;
        if (value<=okMax)  return {label:"è‰¯", class:"ok", comment:"æ¿ƒåº¦éšœå®³ã®æ‡¸å¿µã¯å°ã•ã„"};
        if (value<=warnMax)return {label:"æ³¨æ„", class:"warn", comment:"ã‚„ã‚„é«˜ã‚ã€‚æ–½è‚¥ãƒ»æ½…æ°´ç®¡ç†ã‚’èª¿æ•´"};
        return {label:"è¦æ”¹å–„", class:"bad", comment:"é«˜ã‚ã€‚å¡©é¡é›†ç©ã«æ³¨æ„ã€æ–½è‚¥å‰Šæ¸›/æº¶è„±å¯¾ç­–"};
      }
      if (type==="cec"){
        const okMin = std.ok_min ?? 10, warnMin = std.warn_min ?? 8;
        if (value>=okMin)  return {label:"è‰¯", class:"ok", comment:"ä¿è‚¥åŠ›ã¯ååˆ†"};
        if (value>=warnMin)return {label:"æ³¨æ„", class:"warn", comment:"ã‚„ã‚„ä½ã‚ã€‚æœ‰æ©Ÿç‰©æŠ•å…¥ãƒ»åœŸã¥ãã‚Šã‚’æ¤œè¨"};
        return {label:"è¦æ”¹å–„", class:"bad", comment:"ä½ã‚ã€‚å †è‚¥ãƒ»ç·‘è‚¥ç­‰ã§æ”¹è‰¯ã‚’"};
      }
      if (type==="cn"){
        const ok = std.ok||[10,15], warn=std.warn||[8,20];
        if (value>=ok[0] && value<=ok[1]) return {label:"è‰¯", class:"ok", comment:"åˆ†è§£ãƒãƒ©ãƒ³ã‚¹ã¯è‰¯å¥½"};
        if ((value>=warn[0] && value<ok[0]) || (value>ok[1] && value<=warn[1])) return {label:"æ³¨æ„", class:"warn", comment:"ã‚„ã‚„åã‚Šã€‚è³‡æã®ç¨®é¡/æŠ•å…¥é‡ã‚’èª¿æ•´"};
        return {label:"è¦æ”¹å–„", class:"bad", comment:"åã‚Šå¤§ã€‚C/Nãƒãƒ©ãƒ³ã‚¹ã®è¦‹ç›´ã—ã‚’"};
      }
      if (type==="om"){ // æœ‰æ©Ÿç‰©é‡
        const okMin = std.ok_min ?? 2.0, warnMin = std.warn_min ?? 1.5;
        if (value>=okMin)  return {label:"è‰¯", class:"ok", comment:"æœ‰æ©Ÿç‰©ã¯ååˆ†"};
        if (value>=warnMin)return {label:"æ³¨æ„", class:"warn", comment:"ã‚„ã‚„å°‘ãªã‚ã€‚æœ‰æ©Ÿç‰©è£œçµ¦ã‚’æ¤œè¨"};
        return {label:"è¦æ”¹å–„", class:"bad", comment:"å°‘ãªã„ã€‚å †è‚¥/è¢«è¦†ä½œç‰©ã®æ´»ç”¨ã‚’"};
      }
      if (type==="biotex"){ // å¾®ç”Ÿç‰©å¤šæ§˜æ€§ï¼ˆä»»æ„ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
        const okMin = std.ok_min ?? 500000, warnMin = std.warn_min ?? 200000;
        if (value>=okMin)  return {label:"è‰¯", class:"ok", comment:"ç”Ÿç‰©æ€§ã¯è‰¯å¥½"};
        if (value>=warnMin)return {label:"æ³¨æ„", class:"warn", comment:"ã‚„ã‚„å¼±ã„ã€‚æœ‰æ©Ÿç‰©ãƒ»è¢«è¦†ä½œç‰©ç­‰ã§åº•ä¸Šã’"};
        return {label:"è¦æ”¹å–„", class:"bad", comment:"å¼±ã„ã€‚è€•ã†ã‚“/è³‡ææŠ•å…¥ã‚’è¦‹ç›´ã—"};
      }
      return {label:"â€”", class:"", comment:""};
    }

    /**********************
     * ç”»åƒï¼ˆimage/ï¼‰ã‚’åé›†
     **********************/
    function dirOf(url){ return url.substring(0, url.lastIndexOf("/")); }
    function guessImages(baseDir, fid){
      const exts=["jpg","jpeg","png","webp"]; const urls=[];
      for(let i=1;i<=6;i++) for(const e of exts) urls.push(`${baseDir}/image/${fid}_${i}.${e}`);
      return urls;
    }

    /**********************
     * è¡¨ç¤º
     **********************/
    async function render(f){
      const p = f.properties || {};
      const [lon, lat] = f.geometry?.coordinates || [];
      const CN = (Number.isFinite(num(p.C)) && Number.isFinite(num(p.N)) && num(p.N)!==0) ? num(p.C)/num(p.N) : NaN;

      // æœ€ä¸Šéƒ¨ã®èª¬æ˜ï¼ˆå„ªå…ˆé †ï¼šGeoJSON â†’ field_notes.json â†’ è‡ªå‹•ç”Ÿæˆï¼‰
      let topNote = p["æœ€çµ‚åœ°ç‚¹ã®èª¬æ˜"] || p["å›ºå®šèª¬æ˜"] || "";
      if (!topNote){
        try{
          const notesRes = await fetch("data/standard_data/field_notes.json", {cache:"no-store"});
          if (notesRes.ok){
            const notes = await notesRes.json();
            topNote = notes[p.field_id] || "";
          }
        }catch{}
      }
      if (!topNote){
        // è‡ªå‹•æ–‡ï¼ˆæœ€ä½é™ï¼‰
        const parts=[];
        if (Number.isFinite(num(p.EC)))  parts.push(`EC=${fmt(num(p.EC))}`);
        if (Number.isFinite(num(p.pH)))  parts.push(`pH=${fmt(num(p.pH))}`);
        if (Number.isFinite(num(p.CEC))) parts.push(`CEC=${fmt(num(p.CEC),0)}`);
        if (Number.isFinite(CN))         parts.push(`C/N=${fmt(CN,1)}`);
        topNote = parts.length ? `ä¸»è¦å€¤ï¼š${parts.join(" / ")}` : "";
      }
      if (topNote){
        $("summaryTop").style.display="block";
        $("summaryTop").textContent = topNote;
      } else {
        $("summaryTop").style.display="none";
      }

      // ã‚¿ã‚¤ãƒˆãƒ«ãƒ»å ´æ‰€
      $("fieldName").textContent = p.field_id || pointId;
      $("location").textContent  = p["å ´æ‰€å"] || "";

      // KPI
      $("kEC").textContent   = (p.EC ?? "-");
      $("kpH").textContent   = (p.pH ?? "-");
      $("kCEC").textContent  = (p.CEC ?? "-");
      $("kCN").textContent   = Number.isFinite(CN) ? fmt(CN,1) : "-";
      $("kBio").textContent  = (p["åœŸå£Œå¾®ç”Ÿç‰©å¤šæ§˜æ€§ãƒ»æ´»æ€§å€¤(BIOTREX)"] ?? "-");

      // ãƒ¯ãƒ³ãƒ©ã‚¤ãƒ³è‡ªå‹•
      const auto = (() => {
        const ec=num(p.EC), ph=num(p.pH), cec=num(p.CEC);
        let msg="æ¸¬å®šå€¤ã«åŸºã¥ãç®¡ç†æ–¹é‡ã‚’æ¤œè¨ã§ãã¾ã™ã€‚";
        if(Number.isFinite(ec) && ec<0.10) msg="ECãŒä½ã‚ï¼šæ–½è‚¥ãƒ»æœ‰æ©Ÿç‰©ç®¡ç†ã®æ¤œè¨ãŒæœ‰åŠ¹ã€‚";
        if(Number.isFinite(ph) && (ph<5.5 || ph>7.5)) msg="pHãŒé©æ­£åŸŸå¤–ï¼šçŸ¯æ­£è³‡æã®æ¤œè¨ãŒæœ‰åŠ¹ã€‚";
        if(Number.isFinite(cec) && cec<10) msg="CECãŒä½ã‚ï¼šä¿è‚¥åŠ›å‘ä¸Šï¼ˆæœ‰æ©Ÿç‰©æŠ•å…¥ç­‰ï¼‰ãŒæœ‰åŠ¹ã€‚";
        return msg;
      })();
      $("oneLine").textContent = (p["ä¸»ãªèª²é¡Œ"]||"") ? `ä¸»ãªèª²é¡Œï¼š${p["ä¸»ãªèª²é¡Œ"]}` : auto;

      // ãƒ¡ãƒ¢
      const memoKey = `soilMemo:${src}#${p.field_id || pointId}`;
      const memo = (()=>{ try{ return JSON.parse(localStorage.getItem(memoKey) || "{}"); }catch{return{}} })();
      const fixedDesc = memo.fixedDesc ?? p["å›ºå®šèª¬æ˜"] ?? "";
      const evalTxt   = memo.evalTxt   ?? p["è©•ä¾¡"] ?? "";
      const issue     = memo.issue     ?? p["ä¸»ãªèª²é¡Œ"] ?? "";
      const solution  = memo.solution  ?? p["æ”¹å–„ç­–"] ?? "";
      $("fixedDescView").textContent = fixedDesc || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("evalView").textContent      = evalTxt   || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("issueView").textContent     = issue     || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("solutionView").textContent  = solution  || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("fixedDescInput").value = fixedDesc; $("evalInput").value=evalTxt; $("issueInput").value=issue; $("solutionInput").value=solution;

      let editing=false;
      $("editToggle").onclick = ()=>{ editing=!editing; $("memoEdit").style.display=editing?"block":"none"; $("saveBtn").style.display=editing?"inline-block":"none"; $("editToggle").textContent=editing?"é–²è¦§":"ç·¨é›†"; };
      $("saveBtn").onclick = ()=>{
        const newMemo={ fixedDesc:$("fixedDescInput").value, evalTxt:$("evalInput").value, issue:$("issueInput").value, solution:$("solutionInput").value };
        localStorage.setItem(memoKey, JSON.stringify(newMemo));
        render(f); alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰");
      };

      // åŸºæº– & åˆ¤å®š
      const std = getStd();
      const tbody = $("evalTable").querySelector("tbody"); tbody.innerHTML="";
      const srcLinks = new Set();
      function stdTextOf(k){
        if(!std||!std[k]) return "â€”";
        const s=std[k], id=s.source;
        if (id) srcLinks.add(id);
        if (k==="ph") return `è‰¯:${s.ok?.[0]}ã€œ${s.ok?.[1]} / æ³¨æ„:${s.warn?.[0]}ã€œ${s.warn?.[1]}`;
        if (k==="ec") return `è‰¯:â‰¤${s.ok_max} / æ³¨æ„:â‰¤${s.warn_max}`;
        if (k==="cec")return `è‰¯:â‰¥${s.ok_min} / æ³¨æ„:â‰¥${s.warn_min}`;
        if (k==="cn") return `è‰¯:${s.ok?.[0]}ã€œ${s.ok?.[1]} / æ³¨æ„:${s.warn?.[0]}ã€œ${s.warn?.[1]}`;
        if (k==="om") return `è‰¯:â‰¥${s.ok_min} / æ³¨æ„:â‰¥${s.warn_min}`;
        if (k==="biotex") return `è‰¯:â‰¥${s.ok_min} / æ³¨æ„:â‰¥${s.warn_min}`;
        return "â€”";
      }
      addRow(tbody, "EC (dS/m)", p.EC,  stdTextOf("ec"),    judgeRange(num(p.EC),  std?.ec,  "ec"));
      addRow(tbody, "pH",        p.pH,  stdTextOf("ph"),    judgeRange(num(p.pH),  std?.ph,  "ph"));
      addRow(tbody, "CEC (me/100g)", p.CEC, stdTextOf("cec"), judgeRange(num(p.CEC), std?.cec, "cec"));
      addRow(tbody, "C (ï¼…)",    p.C,   "â€”",               {label:"â€”", class:"", comment:"å‚è€ƒè¡¨ç¤º"});
      addRow(tbody, "N (ï¼…)",    p.N,   "â€”",               {label:"â€”", class:"", comment:"å‚è€ƒè¡¨ç¤º"});
      addRow(tbody, "C/N æ¯”",   Number.isFinite(CN)?fmt(CN,1):"â€”", stdTextOf("cn"), judgeRange(CN, std?.cn, "cn"));
      addRow(tbody, "æœ‰æ©Ÿç‰©é‡", p["æœ‰æ©Ÿç‰©é‡"], stdTextOf("om"),   judgeRange(num(p["æœ‰æ©Ÿç‰©é‡"]), std?.om, "om"));
      const bio = num(p["åœŸå£Œå¾®ç”Ÿç‰©å¤šæ§˜æ€§ãƒ»æ´»æ€§å€¤(BIOTREX)"]);
      addRow(tbody, "å¾®ç”Ÿç‰©å¤šæ§˜æ€§(BIOTREX)", Number.isFinite(bio)?bio:"â€”", stdTextOf("biotex"), judgeRange(bio, std?.biotex, "biotex"));

      // ãƒ©ãƒ³ã‚¯ï¼ˆç°¡æ˜“ï¼šECåˆ¤å®šãƒ™ãƒ¼ã‚¹ï¼‰
      const evEc = judgeRange(num(p.EC), std?.ec, "ec");
      const rank = evEc.label==="è‰¯" ? "A" : (evEc.label==="æ³¨æ„" ? "B" : "C");
      const rankBadge = $("rankBadge"); rankBadge.textContent=`${rank}ãƒ©ãƒ³ã‚¯ï¼ˆä»®ï¼‰`; rankBadge.style.background = (rank==="A"?"#4caf50":rank==="B"?"#ffb300":"#e53935");

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ»æ£’
      const scores = (()=>{ // 0..5ã«æ­£è¦åŒ–
        const ec=num(p.EC), ph=num(p.pH), cec=num(p.CEC);
        const soil_health = Number.isFinite(cec) ? Math.max(0, Math.min(5, Math.round(cec/10))) : 2;
        const safety      = Number.isFinite(ph)  ? (ph>=6 && ph<=7.2 ? 5 : 3) : 3;
        const environment = Number.isFinite(ec)  ? (ec>=0.12?4:3) : 3;
        const taste       = Math.max(0, Math.min(5, Math.round((soil_health + safety)/2)));
        return {taste, soil_health, environment, safety};
      })();
      if (radarChart) radarChart.destroy();
      radarChart = new Chart($("radarChart"), {
        type:"radar",
        data:{ labels:["ãŠã„ã—ã•","åœŸå£Œã®å¥å…¨æ€§","ç’°å¢ƒé…æ…®","å®‰å…¨æ€§"],
          datasets:[{ data:[scores.taste, scores.soil_health, scores.environment, scores.safety],
            fill:true, backgroundColor:"rgba(10,102,194,0.25)", borderColor:"rgba(10,102,194,1)", pointBackgroundColor:"rgba(10,102,194,1)"}]},
        options:{ scales:{ r:{ min:0,max:5,ticks:{display:false,stepSize:1}}}, plugins:{legend:{display:false}} }
      });
      if (barChart) barChart.destroy();
      barChart = new Chart($("barChart"), {
        type:"bar",
        data:{ labels:["EC","pH","CEC","C/N","BIOTREX"],
          datasets:[{ label:"å€¤", data:[num(p.EC)||0, num(p.pH)||0, num(p.CEC)||0, Number.isFinite(CN)?CN:0, Number.isFinite(bio)?bio:0],
            backgroundColor:["#4fc3f7","#81c784","#ffb74d","#9575cd","#90a4ae"] }]},
        options:{ plugins:{legend:{display:false}}, scales:{y:{ beginAtZero:true }} }
      });

      // å‡ºå…¸è¡¨ç¤º
      const box=$("sourcesBox");
      if (SOURCES && srcLinks.size){
        const html=[...srcLinks].map(id=>{
          const s=SOURCES.find(x=>x.id===id);
          return s ? `ãƒ»<a href="${s.url}" target="_blank" rel="noopener">${s.title}ï¼ˆ${s.publisher}ï¼‰</a>` : "";
        }).filter(Boolean).join("<br>");
        box.innerHTML = `<div>åŸºæº–å‡ºå…¸ï¼š</div>${html}`;
      } else {
        box.textContent = "åŸºæº–å‡ºå…¸ï¼šãƒ­ãƒ¼ã‚«ãƒ«åŸºæº–ï¼ˆstandards.jsonï¼‰";
      }

      // ãƒ„ãƒ¼ãƒ«ç¾¤
      $("copyCoordBtn").onclick = ()=>{
        if (Number.isFinite(lat) && Number.isFinite(lon)) copyText(`${lat.toFixed(6)}, ${lon.toFixed(6)}`);
        else alert("åº§æ¨™ãŒã‚ã‚Šã¾ã›ã‚“");
      };
      $("downloadJsonBtn").onclick = ()=> downloadBlob(`soil_${p.field_id||pointId}.json`, JSON.stringify(p,null,2), "application/json");
      $("downloadCsvBtn").onclick  = ()=> downloadBlob(`soil_${p.field_id||pointId}.csv`, jsonToCsv(p), "text/csv");

      // å…¨å±æ€§
      const wrap=$("analysisWrap"); wrap.innerHTML=""; wrap.appendChild(renderPropsTable(p));

      // ç”»åƒ
      const baseDir = dirOf(src);
      const gallery = $("gallery"); gallery.innerHTML="";
      const note=$("galleryNote"); note.textContent="";
      let imgs=[];
      if (Array.isArray(p.images) && p.images.length){
        imgs = p.images.map(u => u.match(/^https?:\/\//) ? u : `${baseDir}/${u.replace(/^\.?\//,"")}`);
      } else if (typeof p.images==="string" && p.images.trim()){
        imgs = p.images.split(",").map(s=>s.trim()).filter(Boolean).map(u => u.match(/^https?:\/\//)?u:`${baseDir}/${u.replace(/^\.?\//,"")}`);
      } else {
        imgs = guessImages(baseDir, p.field_id||pointId);
      }
      let shown=0;
      if (imgs.length===0){
        note.textContent="ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚image/<ID>_*.jpg ã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚";
      } else {
        imgs.forEach(u=>{
          const img=new Image(); img.loading="lazy"; img.alt=p.field_id||""; img.src=u;
          img.onerror=()=>{ img.style.display="none"; };
          img.onload=()=>{ shown++; };
          img.onclick=()=>window.open(u,"_blank","noopener");
          gallery.appendChild(img);
        });
        setTimeout(()=>{ if (shown===0) note.textContent="ç”»åƒã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚„æ‹¡å¼µå­ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"; }, 800);
      }
    }
  </script>
</body>
</html>
``