<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>åœŸå£Œè¨ºæ–­çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --c-brand:#0a66c2; --c-text:#333; --c-sub:#555; --c-muted:#888;
      --c-border:#eee; --c-bg:#fff; --c-ok:#4caf50; --c-warn:#ffb300; --c-bad:#e53935;
      --shadow:0 2px 8px rgba(0,0,0,.06); --radius:12px;
    }
    html,body{margin:0;padding:0}
    body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif; line-height:1.7;
         padding:16px; max-width:1100px; margin:0 auto; color:var(--c-text); background:#f7f7f8;}
    a{color:var(--c-brand); text-decoration:none;} 
    a:hover{text-decoration:underline;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between;
            margin-bottom:14px; flex-wrap:wrap;}
    .pill{display:inline-flex; align-items:center; gap:6px; background:#f1f3f5;
          border-radius:999px; padding:2px 10px; font-size:12px; color:var(--c-sub);}
    .btn{border:1px solid #ddd; background:#fafafa; padding:6px 10px; border-radius:8px; cursor:pointer;}
    .btn:hover{background:#f0f0f0;}
    .btn.primary{border-color:var(--c-brand); background:var(--c-brand); color:#fff;}
    .badge{display:inline-block; color:#fff; padding:4px 12px; border-radius:6px;
           margin-right:6px; font-weight:700; font-size:13px;}
    .muted{color:var(--c-muted);}
    .card{background:var(--c-bg); border:1px solid var(--c-border); border-radius:var(--radius);
          padding:14px; box-shadow:var(--shadow);}
    .card h2{font-size:16px; margin:0 0 10px;}
    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    .kpi{display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;}
    .k{background:#f9f9fb; border:1px solid #f0f0f0; border-radius:10px; padding:10px;}
    .k label{display:block; font-size:12px; color:var(--c-sub);}
    .k b{font-size:20px;}
    .eval-table{width:100%; border-collapse:collapse;}
    .eval-table th,.eval-table td{border-bottom:1px solid var(--c-border);
                                 padding:6px 8px; text-align:left;}
    .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff;}
    .chip.ok{background:var(--c-ok);}
    .chip.warn{background:var(--c-warn); color:#000;}
    .chip.bad{background:var(--c-bad);}
    .gallery{display:grid; grid-template-columns:repeat(3,1fr); gap:10px;}
    .gallery img{width:100%; height:180px; object-fit:cover; border-radius:8px;
                 border:1px solid var(--c-border); box-shadow:var(--shadow);}
    .warn{background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:10px;}
    .summary-top{background:#fff; border-left:5px solid var(--c-brand); padding:10px 12px;
                 border-radius:8px; box-shadow:var(--shadow);}
  </style>
</head>
<body>

  <!-- Top -->
  <div class="topbar">
    <div class="row">
      <a href="./index.html">â† åœ°å›³ã¸æˆ»ã‚‹</a>
      <span class="pill" id="idPill"></span>
      <span class="pill" id="srcPill"></span>
    </div>
    <div class="row">
      <label>ç”¨é€”</label>
      <select id="landuse">
        <option value="paddy">æ°´ç”°</option>
        <option value="upland">ç•‘</option>
      </select>
      <button class="btn" id="prevBtn">â† å‰ã¸</button>
      <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      <button class="btn" id="copyLinkBtn">ğŸ”— ã‚³ãƒ”ãƒ¼</button>
      <button class="btn" id="editToggle">ç·¨é›†</button>
      <button class="btn primary" id="saveBtn" style="display:none;">ä¿å­˜</button>
    </div>
  </div>

  <!-- æœ€çµ‚åœ°ç‚¹ã®èª¬æ˜ -->
  <div id="summaryTop" class="summary-top" style="display:none; margin-bottom:12px;"></div>

  <h1 id="fieldName" style="margin:6px 0;"></h1>
  <div id="location" class="muted"></div>

  <!-- Badges -->
  <div style="margin-top:10px;">
    <span class="badge" id="rankBadge"></span>
    <span class="badge" style="background:var(--c-ok);">soil_pointså‚ç…§</span>
  </div>

  <!-- One-liner -->
  <p id="oneLine" style="font-weight:700; margin-top:10px;"></p>

  <!-- KPI -->
  <div class="card">
    <h2>ä¸»è¦æŒ‡æ¨™</h2>
    <div class="kpi">
      <div class="k"><label>EC</label><b id="kEC">-</b></div>
      <div class="k"><label>pH</label><b id="kpH">-</b></div>
      <div class="k"><label>CEC</label><b id="kCEC">-</b></div>
      <div class="k"><label>C/Næ¯”</label><b id="kCN">-</b></div>
      <div class="k"><label>å¾®ç”Ÿç‰©å¤šæ§˜æ€§</label><b id="kBio">-</b></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btn" id="copyCoordBtn">ğŸ“ åº§æ¨™ã‚³ãƒ”ãƒ¼</button>
      <button class="btn" id="downloadJsonBtn">â¬‡ JSON</button>
      <button class="btn" id="downloadCsvBtn">â¬‡ CSV</button>
    </div>
  </div>

  <!-- Memo -->
  <div class="card" style="margin-top:12px;">
    <h2>ãƒ¡ãƒ¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</h2>
    <div id="memoView">
      <div><b>å›ºå®šèª¬æ˜ï¼š</b><span id="fixedDescView"></span></div>
      <div><b>è©•ä¾¡ï¼š</b><span id="evalView"></span></div>
      <div><b>ä¸»ãªèª²é¡Œï¼š</b><span id="issueView"></span></div>
      <div><b>æ”¹å–„ç­–ï¼š</b><span id="solutionView"></span></div>
    </div>

    <div id="memoEdit" style="display:none; margin-top:10px;">
      <div style="margin-bottom:8px;">
        <div style="font-weight:700; margin-bottom:4px;">å›ºå®šèª¬æ˜</div>
        <input type="text" id="fixedDescInput">
      </div>
      <div style="margin-bottom:8px;">
        <div style="font-weight:700; margin-bottom:4px;">è©•ä¾¡</div>
        <input type="text" id="evalInput">
      </div>
      <div style="margin-bottom:8px;">
        <div style="font-weight:700; margin-bottom:4px;">ä¸»ãªèª²é¡Œ</div>
        <textarea id="issueInput" rows="3"></textarea>
      </div>
      <div>
        <div style="font-weight:700; margin-bottom:4px;">æ”¹å–„ç­–</div>
        <textarea id="solutionInput" rows="3"></textarea>
      </div>
    </div>
  </div>

  <!-- Evaluation -->
  <div class="card" style="margin-top:12px;">
    <h2>æ¨™æº–å€¤ã¨ã®æ¯”è¼ƒ</h2>
    <table class="eval-table" id="evalTable">
      <thead>
        <tr><th>é …ç›®</th><th>å€¤</th><th>æ¨™æº–</th><th>åˆ¤å®š</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="sourcesBox" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- Images -->
  <div class="card" style="margin-top:12px;">
    <h2>ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆimage/ï¼‰</h2>
    <div id="gallery" class="gallery"></div>
    <div id="galleryNote" class="muted" style="margin-top:6px;"></div>
  </div>

  <!-- All attributes -->
  <details>
    <summary>ğŸ”¬ soil_points ã®å±æ€§ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰</summary>
    <div id="analysisWrap"></div>
  </details>

  <script>
    /* JSï¼šâ€» ãƒãƒ£ãƒ¼ãƒˆéƒ¨åˆ†ã¯å®Œå…¨ã«å‰Šé™¤æ¸ˆã¿ï¼ˆæç”»ãªã—ï¼‰ */

    const $ = id => document.getElementById(id);
    const num = x => { const n = Number(x); return Number.isFinite(n) ? n : NaN; };
    const fmt = (v, d=2) => Number.isFinite(v) ? v.toFixed(d) : "â€”";
    async function copyText(t){ try{await navigator.clipboard.writeText(t);}catch{} }

    function jsonToCsv(obj){
      const keys=Object.keys(obj);
      const vals=keys.map(k=>`"${String(obj[k]??"").replace(/"/g,'""')}"`);
      return keys.join(",")+"\n"+vals.join(",")+"\n";
    }
    function downloadBlob(name, text){
      const blob=new Blob([text],{type:"text/plain"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob); a.download=name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),500);
    }

    const params=new URLSearchParams(location.search);
    const pointId=params.get("id");
    const src=params.get("src") || "data/Saitama/Chichibu/Oota/soil_points.geojson";

    $("idPill").textContent=`ID: ${pointId}`;
    $("srcPill").textContent=`src: ${src}`;

    let featureList=[], currentIndex=-1;
    let STANDARDS=null, SOURCES=[];

    main();

    async function main(){
      if(!pointId){
        document.body.innerHTML="<div class='warn'>ID ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>"; return;
      }

      try{
        const s=await fetch("data/standard_data/standards.json");
        if(s.ok){
          const j=await s.json();
          STANDARDS=j;
          SOURCES=j.sources||[];
          $("landuse").value=j.meta?.default_landuse||"paddy";
        }
      }catch{}

      const res=await fetch(src);
      const fc=await res.json();
      featureList=fc.features||[];
      currentIndex=featureList.findIndex(f=>String(f.properties?.field_id)===String(pointId));

      if(currentIndex<0){
        document.body.innerHTML="<div class='warn'>ID ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>"; return;
      }

      $("prevBtn").onclick=()=>{
        if(currentIndex>0){
          const id=featureList[currentIndex-1].properties.field_id;
          location.href=`soil.html?id=${id}&src=${src}`;
        }
      };
      $("nextBtn").onclick=()=>{
        if(currentIndex<featureList.length-1){
          const id=featureList[currentIndex+1].properties.field_id;
          location.href=`soil.html?id=${id}&src=${src}`;
        }
      };
      $("copyLinkBtn").onclick=()=>copyText(location.href);

      $("landuse").onchange=()=>render(featureList[currentIndex]);

      render(featureList[currentIndex]);
    }

    function getStd(){
      const lu=$("landuse").value;
      return STANDARDS?.standards?.[lu] || null;
    }

    function addRow(tbody, label, v, stdText, judge){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${label}</td>
        <td>${v??"â€”"}</td>
        <td>${stdText||"â€”"}</td>
        <td><span class="chip ${judge.class||""}">${judge.label}</span></td>
        <td>${judge.comment||""}</td>
      `;
      tbody.appendChild(tr);
    }

    function judgeRange(value, std, type){
      if(!Number.isFinite(value)) return {label:"â€”", class:"", comment:"å€¤ãªã—"};
      if(!std) return {label:"â€”", class:"", comment:"åŸºæº–ãªã—"};

      if(type==="ph"){
        const ok=std.ok||[5.5,6.5], w=std.warn||[5.0,7.5];
        if(value>=ok[0] && value<=ok[1]) return{label:"è‰¯",class:"ok",comment:"é©æ­£"};
        if(value>=w[0] && value<=w[1]) return{label:"æ³¨æ„",class:"warn",comment:"ã‚„ã‚„å¤–ã‚Œ"};
        return{label:"è¦æ”¹å–„",class:"bad",comment:"é©æ­£åŸŸå¤–"};
      }
      if(type==="ec"){
        const o=std.ok_max??0.5, w=std.warn_max??0.8;
        if(value<=o) return{label:"è‰¯",class:"ok",comment:"æ­£å¸¸"};
        if(value<=w) return{label:"æ³¨æ„",class:"warn",comment:"ã‚„ã‚„é«˜ã„"};
        return{label:"è¦æ”¹å–„",class:"bad",comment:"é«˜ã„"};
      }
      if(type==="cec"){
        const o=std.ok_min??10, w=std.warn_min??8;
        if(value>=o) return{label:"è‰¯",class:"ok",comment:"ååˆ†"};
        if(value>=w) return{label:"æ³¨æ„",class:"warn",comment:"ã‚„ã‚„ä½ã„"};
        return{label:"è¦æ”¹å–„",class:"bad",comment:"ä½ã„"};
      }
      return{label:"â€”",class:"",comment:""};
    }

    function dirOf(p){ return p.substring(0,p.lastIndexOf("/")); }

    function guessImages(baseDir, fid){
      const ex=["png","jpg","jpeg","webp"];
      const out=[];
      ex.forEach(e=>out.push(`${baseDir}/image/${fid}.${e}`));
      for(let i=1;i<=6;i++) ex.forEach(e=>out.push(`${baseDir}/image/${fid}_${i}.${e}`));
      for(let i=1;i<=6;i++) ex.forEach(e=>out.push(`${baseDir}/image/${fid}-${i}.${e}`));
      return out;
    }

    async function render(f){
      const p=f.properties||{};
      const [lon,lat]=f.geometry.coordinates||[];

      let topNote=p["æœ€çµ‚åœ°ç‚¹ã®èª¬æ˜"] || p["å›ºå®šèª¬æ˜"] || "";
      if(!topNote){
        try{
          const r=await fetch("data/standard_data/field_notes.json");
          if(r.ok){
            const notes=await r.json();
            topNote=notes[p.field_id]||"";
          }
        }catch{}
      }
      if(topNote){
        $("summaryTop").style.display="block";
        $("summaryTop").textContent=topNote;
      }

      $("fieldName").textContent=p.field_id;
      $("location").textContent=p["å ´æ‰€å"]||"";

      const CN=(Number.isFinite(num(p.C))&&Number.isFinite(num(p.N))&&num(p.N)!==0)?num(p.C)/num(p.N):NaN;

      $("kEC").textContent=p.EC??"-";
      $("kpH").textContent=p.pH??"-";
      $("kCEC").textContent=p.CEC??"-";
      $("kCN").textContent=Number.isFinite(CN)?fmt(CN,1):"-";
      $("kBio").textContent=p["åœŸå£Œå¾®ç”Ÿç‰©å¤šæ§˜æ€§ãƒ»æ´»æ€§å€¤(BIOTREX)"]??"-";

      $("oneLine").textContent="æ¸¬å®šå€¤ã«åŸºã¥ãç®¡ç†æ–¹é‡ã‚’æ¤œè¨ã§ãã¾ã™ã€‚";

      const memoKey=`soilMemo:${src}#${p.field_id}`;
      const memo=JSON.parse(localStorage.getItem(memoKey)||"{}");

      $("fixedDescView").textContent=memo.fixedDesc||"ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("evalView").textContent=memo.evalTxt||"ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("issueView").textContent=memo.issue||"ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("solutionView").textContent=memo.solution||"ï¼ˆæœªå…¥åŠ›ï¼‰";

      $("fixedDescInput").value=memo.fixedDesc||"";
      $("evalInput").value=memo.evalTxt||"";
      $("issueInput").value=memo.issue||"";
      $("solutionInput").value=memo.solution||"";

      let editing=false;
      $("editToggle").onclick=()=>{
        editing=!editing;
        $("memoEdit").style.display=editing?"block":"none";
        $("saveBtn").style.display=editing?"inline-block":"none";
      };
      $("saveBtn").onclick=()=>{
        const m={
          fixedDesc:$("fixedDescInput").value,
          evalTxt:$("evalInput").value,
          issue:$("issueInput").value,
          solution:$("solutionInput").value
        };
        localStorage.setItem(memoKey,JSON.stringify(m));
        render(f);
      };

      const std=getStd();
      const tbody=$("evalTable").querySelector("tbody");
      tbody.innerHTML="";

      addRow(tbody,"EC",p.EC,"",judgeRange(num(p.EC),std?.ec,"ec"));
      addRow(tbody,"pH",p.pH,"",judgeRange(num(p.pH),std?.ph,"ph"));
      addRow(tbody,"CEC",p.CEC,"",judgeRange(num(p.CEC),std?.cec,"cec"));
      addRow(tbody,"C/Næ¯”",Number.isFinite(CN)?fmt(CN,1):"","",{label:"â€”",class:"",comment:""});

      const rank = (num(p.EC)<=0.5?"A":num(p.EC)<=0.8?"B":"C");
      $("rankBadge").textContent=rank+"ãƒ©ãƒ³ã‚¯";
      $("rankBadge").style.background=(rank==="A"?"#4caf50":rank==="B"?"#ffb300":"#e53935");

      $("copyCoordBtn").onclick=()=>copyText(`${lat}, ${lon}`);
      $("downloadJsonBtn").onclick=()=>downloadBlob(`soil_${p.field_id}.json`,JSON.stringify(p,null,2));
      $("downloadCsvBtn").onclick=()=>downloadBlob(`soil_${p.field_id}.csv`,jsonToCsv(p));

      const wrap=$("analysisWrap"); wrap.innerHTML="";
      wrap.appendChild(renderPropsTable(p));

      const baseDir=dirOf(src);
      let imgs=[];
      if(Array.isArray(p.images)) imgs=p.images.map(u=>baseDir+"/"+u);
      else imgs=guessImages(baseDir,p.field_id);

      const gal=$("gallery"); gal.innerHTML="";
      let shown=0;
      imgs.forEach(u=>{
        const img=new Image(); img.src=u;
        img.onerror=()=>img.style.display="none";
        img.onload=()=>shown++;
        img.onclick=()=>window.open(u,"_blank");
        gal.appendChild(img);
      });

      setTimeout(()=>{
        if(shown===0) $("galleryNote").textContent="ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
      },600);
    }
  </script>
</body>
</html>