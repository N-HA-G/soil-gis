<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>åœŸå£Œè¨ºæ–­çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; line-height: 1.7; padding: 16px; max-width: 980px; margin: 0 auto; }
    a { color:#0a66c2; text-decoration:none; }
    a:hover { text-decoration:underline; }

    .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .pill { display:inline-block; background:#eee; border-radius:999px; padding:2px 10px; font-size:12px; }
    .btn { border:1px solid #ccc; background:#fafafa; padding:6px 10px; border-radius:8px; cursor:pointer; }
    .btn:hover { background:#f0f0f0; }

    .badge { display:inline-block; color:#fff; padding:4px 12px; border-radius:6px; margin-right:6px; font-weight:700; font-size:13px; }
    .stars { color:#ff9800; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 760px){ .grid { grid-template-columns: 1fr; } }

    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:12px; box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .card h2 { font-size:16px; margin: 0 0 8px; }
    .kpi { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; }
    @media (max-width: 760px){ .kpi { grid-template-columns: 1fr 1fr; } }
    .k { background:#f9f9f9; border-radius:10px; padding:10px; }
    .k label { display:block; font-size:12px; color:#666; }
    .k b { font-size:20px; }

    details { margin-top: 8px; background:#fafafa; padding:10px; border-radius:12px; border:1px solid #eee; }
    table.meta { border-collapse: collapse; width:100%; }
    table.meta th, table.meta td { border-bottom:1px solid #eee; padding:6px 8px; vertical-align: top; }
    table.meta th { width: 220px; text-align:left; white-space: nowrap; color:#666; font-weight:600; }

    textarea, input[type="text"] { width:100%; box-sizing:border-box; border:1px solid #ccc; border-radius:8px; padding:8px; }
    .warn { background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:10px; }
    canvas { max-width: 100%; display:block; margin: 10px auto 0; }
  </style>
</head>
<body>

  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <a href="./index.html">â† åœ°å›³ã¸æˆ»ã‚‹</a>
      <span class="pill" id="idPill"></span>
      <span class="pill" id="srcPill"></span>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn" id="prevBtn">â† å‰ã¸</button>
      <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      <button class="btn" id="editToggle">ç·¨é›†</button>
      <button class="btn" id="saveBtn" style="display:none;">ä¿å­˜</button>
    </div>
  </div>

  <h1 id="fieldName" style="margin:6px 0;"></h1>
  <div id="location" style="color:#555;"></div>

  <div style="margin-top:10px;">
    <span class="badge" id="rankBadge"></span>
    <span class="badge" style="background:#4caf50;">soil_pointså‚ç…§</span>
  </div>

  <p id="oneLine" style="font-weight:700; margin-top:10px;"></p>

  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h2>ä¸»è¦æŒ‡æ¨™</h2>
      <div class="kpi">
        <div class="k"><label>EC</label><b id="kEC">-</b></div>
        <div class="k"><label>pH</label><b id="kpH">-</b></div>
        <div class="k"><label>CEC</label><b id="kCEC">-</b></div>
        <div class="k"><label>æ¡å–æ—¥</label><b id="kDate" style="font-size:14px;">-</b></div>
        <div class="k"><label>åº§æ¨™</label><b id="kCoord" style="font-size:14px;">-</b></div>
      </div>
    </div>

    <div class="card">
      <h2>ãƒ–ãƒ©ãƒ³ãƒ‰è©•ä¾¡ï¼ˆä»®ï¼‰</h2>
      <div>
        <div>ğŸš ãŠã„ã—ã•ï¼š<span class="stars" id="taste"></span></div>
        <div>ğŸŒ± åœŸå£Œã®å¥å…¨æ€§ï¼š<span class="stars" id="soilHealth"></span></div>
        <div>ğŸŒ ç’°å¢ƒé…æ…®ï¼š<span class="stars" id="environment"></span></div>
        <div>ğŸ›¡ å®‰å…¨æ€§ï¼š<span class="stars" id="safety"></span></div>
      </div>
      <canvas id="radarChart" width="380" height="380"></canvas>
    </div>

    <div class="card full" style="grid-column: 1 / -1;">
      <h2>ãƒ¡ãƒ¢ï¼ˆç·¨é›†å¯èƒ½ï¼šlocalStorageä¿å­˜ï¼‰</h2>
      <div id="memoView">
        <div><b>å›ºå®šèª¬æ˜ï¼š</b><span id="fixedDescView"></span></div>
        <div><b>è©•ä¾¡ï¼š</b><span id="evalView"></span></div>
        <div><b>ä¸»ãªèª²é¡Œï¼š</b><span id="issueView"></span></div>
        <div><b>æ”¹å–„ç­–ï¼š</b><span id="solutionView"></span></div>
      </div>

      <div id="memoEdit" style="display:none; margin-top:10px;">
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">å›ºå®šèª¬æ˜</div>
          <input type="text" id="fixedDescInput" placeholder="ä¾‹ï¼šåœ°å½¢ãƒ»åœŸåœ°åˆ©ç”¨ã®èª¬æ˜ãªã©">
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">è©•ä¾¡</div>
          <input type="text" id="evalInput" placeholder="ä¾‹ï¼šè‰¯ / æ™®é€š / è¦æ”¹å–„ ãªã©">
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">ä¸»ãªèª²é¡Œ</div>
          <textarea id="issueInput" rows="3" placeholder="ä¸»ãªèª²é¡Œã‚’è¨˜å…¥"></textarea>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:4px;">æ”¹å–„ç­–</div>
          <textarea id="solutionInput" rows="3" placeholder="æ”¹å–„ç­–ã‚’è¨˜å…¥"></textarea>
        </div>
      </div>
    </div>
  </div>

  <details>
    <summary>ğŸ”¬ soil_points ã®å±æ€§ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰</summary>
    <div id="analysisWrap"></div>
  </details>

  https://cdn.jsdelivr.net/npm/chart.js</script>
  <script>
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    const src = params.get("src") || "data/Saitama/Chichibu/Oota/soil_points.geojson";

    document.getElementById("idPill").textContent = `ID: ${id ?? "-"}`;
    document.getElementById("srcPill").textContent = `src: ${src}`;

    function rankColor(rank, alpha=1){
      switch(rank){
        case "A": return `rgba(76,175,80,${alpha})`;
        case "B": return `rgba(255,193,7,${alpha})`;
        case "C": return `rgba(244,67,54,${alpha})`;
        default: return `rgba(158,158,158,${alpha})`;
      }
    }
    function star(n){
      const k = Math.max(0, Math.min(5, Number(n)||0));
      return "â˜…".repeat(k) + "â˜†".repeat(5-k);
    }

    // ä»®ãƒ©ãƒ³ã‚¯ï¼šECã§ã–ã£ãã‚Šï¼ˆå¾Œã§é–¾å€¤ã‚’ä¸€ç·’ã«æ±ºã‚ã‚ˆã†ï¼‰
    function calcRank(p){
      const ec = Number(p?.EC);
      if (!Number.isFinite(ec)) return "â€”";
      if (ec >= 0.15) return "B";
      if (ec >= 0.10) return "C";
      return "C";
    }
    // ä»®ã‚¹ã‚³ã‚¢ï¼šEC/pH/CEC
    function calcScores(p){
      const ec  = Number(p?.EC);
      const ph  = Number(p?.pH);
      const cec = Number(p?.CEC);
      const clamp = x => Math.max(0, Math.min(5, x));
      const soil_health = clamp(Math.round(Number.isFinite(cec) ? (cec/10) : 2));
      const safety      = clamp(Number.isFinite(ph) ? ((ph>=6 && ph<=7.2)?5:3) : 3);
      const environment = clamp(Number.isFinite(ec) ? ((ec>=0.12)?4:3) : 3);
      const taste       = clamp(Math.round((soil_health + safety)/2));
      return { taste, soil_health, environment, safety };
    }

    function renderPropsTable(props){
      const table = document.createElement("table");
      table.className = "meta";
      Object.entries(props || {}).forEach(([k,v])=>{
        const tr=document.createElement("tr");
        const th=document.createElement("th"); th.textContent=k;
        const td=document.createElement("td"); td.textContent=(v ?? "");
        tr.append(th,td);
        table.append(tr);
      });
      return table;
    }

    // localStorageä¿å­˜ï¼ˆidã”ã¨ï¼‰
    function loadMemo(fieldId){
      try{
        const raw = localStorage.getItem("soilMemo:"+fieldId);
        return raw ? JSON.parse(raw) : {};
      }catch{ return {}; }
    }
    function saveMemo(fieldId, memo){
      localStorage.setItem("soilMemo:"+fieldId, JSON.stringify(memo));
    }

    let featureList = [];
    let currentIndex = -1;
    let radarChart = null;

    async function main(){
      if(!id){
        document.body.innerHTML = `<div class="warn">IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¾‹ï¼š<code>soil.html?id=F001</code></div>`;
        return;
      }

      let fc;
      try{
        const res = await fetch(src, {cache:"no-store"});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        fc = await res.json();
      }catch(e){
        document.body.innerHTML = `<div class="warn">soil_points ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼š<code>${src}</code><br>ã‚¨ãƒ©ãƒ¼ï¼š<code>${String(e)}</code></div>`;
        return;
      }

      featureList = fc.features || [];
      currentIndex = featureList.findIndex(f => String(f?.properties?.field_id) === String(id));
      if(currentIndex < 0){
        document.body.innerHTML = `<div class="warn">ID <code>${id}</code> ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆsrc=${src}ï¼‰ã€‚</div>`;
        return;
      }
      render(featureList[currentIndex]);
      setupNavButtons();
    }

    function setupNavButtons(){
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");

      prevBtn.disabled = (currentIndex <= 0);
      nextBtn.disabled = (currentIndex >= featureList.length-1);

      prevBtn.onclick = () => {
        if(currentIndex <= 0) return;
        const fid = featureList[currentIndex-1].properties?.field_id;
        location.href = `soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
      };
      nextBtn.onclick = () => {
        if(currentIndex >= featureList.length-1) return;
        const fid = featureList[currentIndex+1].properties?.field_id;
        location.href = `soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
      };
    }

    function render(f){
      const p = f.properties || {};
      const [lon, lat] = f.geometry?.coordinates || [];

      document.getElementById("fieldName").textContent = p.field_id || id;
      document.getElementById("location").textContent  = p["å ´æ‰€å"] || "";

      document.getElementById("kEC").textContent   = (p.EC ?? "-");
      document.getElementById("kpH").textContent   = (p.pH ?? "-");
      document.getElementById("kCEC").textContent  = (p.CEC ?? "-");
      document.getElementById("kDate").textContent = (p["æ¡å–æ—¥"] ?? "-");
      document.getElementById("kCoord").textContent = (Number.isFinite(lat) && Number.isFinite(lon)) ? `${lat.toFixed(6)}, ${lon.toFixed(6)}` : "-";

      // ä¸€è¨€ï¼ˆèª²é¡ŒãŒã‚ã‚Œã°ãã‚Œã‚’å„ªå…ˆã€ãªã‘ã‚Œã°è‡ªå‹•ç”Ÿæˆï¼‰
      const auto = (() => {
        const ec = Number(p.EC);
        const ph = Number(p.pH);
        const cec = Number(p.CEC);
        let msg = "æ¸¬å®šå€¤ã«åŸºã¥ãç®¡ç†æ–¹é‡ã‚’æ¤œè¨ã§ãã¾ã™ã€‚";
        if(Number.isFinite(ec) && ec < 0.10) msg = "ECãŒä½ã‚ï¼šæ–½è‚¥ãƒ»æœ‰æ©Ÿç‰©ç®¡ç†ã®æ¤œè¨ãŒæœ‰åŠ¹ã€‚";
        if(Number.isFinite(ph) && (ph < 5.5 || ph > 7.5)) msg = "pHãŒé©æ­£åŸŸå¤–ï¼šçŸ¯æ­£è³‡æã®æ¤œè¨ãŒæœ‰åŠ¹ã€‚";
        if(Number.isFinite(cec) && cec < 10) msg = "CECãŒä½ã‚ï¼šä¿è‚¥åŠ›å‘ä¸Šï¼ˆæœ‰æ©Ÿç‰©æŠ•å…¥ç­‰ï¼‰ãŒæœ‰åŠ¹ã€‚";
        return msg;
      })();

      const memo = loadMemo(p.field_id || id);
      const fixedDesc = memo.fixedDesc ?? p["å›ºå®šèª¬æ˜"] ?? "";
      const evalTxt   = memo.evalTxt   ?? p["è©•ä¾¡"] ?? "";
      const issue     = memo.issue     ?? p["ä¸»ãªèª²é¡Œ"] ?? "";
      const solution  = memo.solution  ?? p["æ”¹å–„ç­–"] ?? "";

      document.getElementById("oneLine").textContent = issue ? `ä¸»ãªèª²é¡Œï¼š${issue}` : auto;

      document.getElementById("fixedDescView").textContent = fixedDesc || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      document.getElementById("evalView").textContent      = evalTxt   || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      document.getElementById("issueView").textContent     = issue     || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      document.getElementById("solutionView").textContent  = solution  || "ï¼ˆæœªå…¥åŠ›ï¼‰";

      document.getElementById("fixedDescInput").value = fixedDesc;
      document.getElementById("evalInput").value      = evalTxt;
      document.getElementById("issueInput").value     = issue;
      document.getElementById("solutionInput").value  = solution;

      // ãƒ©ãƒ³ã‚¯ï¼†ã‚¹ã‚³ã‚¢
      const rank = calcRank(p);
      const rankBadge = document.getElementById("rankBadge");
      rankBadge.textContent = `${rank}ãƒ©ãƒ³ã‚¯ï¼ˆä»®ï¼‰`;
      rankBadge.style.background = rankColor(rank);

      const scores = calcScores(p);
      document.getElementById("taste").textContent       = star(scores.taste);
      document.getElementById("soilHealth").textContent  = star(scores.soil_health);
      document.getElementById("environment").textContent = star(scores.environment);
      document.getElementById("safety").textContent      = star(scores.safety);

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼æ›´æ–°
      const ctx = document.getElementById("radarChart");
      if (radarChart) radarChart.destroy();
      radarChart = new Chart(ctx, {
        type:"radar",
        data:{
          labels:["ãŠã„ã—ã•","åœŸå£Œã®å¥å…¨æ€§","ç’°å¢ƒé…æ…®","å®‰å…¨æ€§"],
          datasets:[{
            data:[scores.taste, scores.soil_health, scores.environment, scores.safety],
            fill:true,
            backgroundColor: rankColor(rank, 0.25),
            borderColor: rankColor(rank, 1),
            pointBackgroundColor: rankColor(rank, 1)
          }]
        },
        options:{
          scales:{ r:{ min:0, max:5, ticks:{display:false, stepSize:1} } },
          plugins:{ legend:{display:false} }
        }
      });

      // ã™ã¹ã¦ã®å±æ€§
      const wrap = document.getElementById("analysisWrap");
      wrap.innerHTML = "";
      wrap.appendChild(renderPropsTable(p));

      // ç·¨é›†ãƒˆã‚°ãƒ«ï¼†ä¿å­˜
      const editToggle = document.getElementById("editToggle");
      const saveBtn = document.getElementById("saveBtn");
      const memoEdit = document.getElementById("memoEdit");

      let editing = false;
      editToggle.onclick = () => {
        editing = !editing;
        memoEdit.style.display = editing ? "block" : "none";
        saveBtn.style.display = editing ? "inline-block" : "none";
        editToggle.textContent = editing ? "é–²è¦§" : "ç·¨é›†";
      };

      saveBtn.onclick = () => {
        const newMemo = {
          fixedDesc: document.getElementById("fixedDescInput").value,
          evalTxt: document.getElementById("evalInput").value,
          issue: document.getElementById("issueInput").value,
          solution: document.getElementById("solutionInput").value
        };
        saveMemo(p.field_id || id, newMemo);
        // å†æç”»
        render(f);
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰");
      };
    }

    main();
  </script>
</body>
</html>