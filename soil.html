<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>åœŸå£Œè¨ºæ–­çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --c-brand:#0a66c2; --c-text:#333; --c-sub:#555; --c-muted:#888;
      --c-border:#eee; --c-bg:#fff; --c-ok:#4caf50; --c-warn:#ffb300; --c-bad:#e53935;
      --shadow:0 2px 8px rgba(0,0,0,.06); --radius:12px;
    }
    html,body{margin:0;padding:0}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",sans-serif; line-height:1.7;
      padding:16px; max-width:1100px; margin:0 auto; color:var(--c-text); background:#f7f7f8;
    }
    a{color:var(--c-brand); text-decoration:none;} a:hover{text-decoration:underline;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between;
            margin-bottom:14px; flex-wrap:wrap;}
    .pill{display:inline-flex; align-items:center; gap:6px; background:#f1f3f5;
          border-radius:999px; padding:2px 10px; font-size:12px; color:var(--c-sub);}
    .btn{border:1px solid #ddd; background:#fafafa; padding:6px 10px; border-radius:8px; cursor:pointer;}
    .btn:hover{background:#f0f0f0;}
    .btn.primary{border-color:var(--c-brand); background:var(--c-brand); color:#fff;}
    .badge{display:inline-block; color:#fff; padding:4px 12px; border-radius:6px;
           margin-right:6px; font-weight:700; font-size:13px;}
    .muted{color:var(--c-muted);}
    .card{background:var(--c-bg); border:1px solid var(--c-border); border-radius:var(--radius);
          padding:14px; box-shadow:var(--shadow);}
    .card h2{font-size:16px; margin:0 0 10px;}
    .grid{display:grid; grid-template-columns:1fr; gap:14px;}
    .kpi{display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;}
    .k{background:#f9f9fb; border:1px solid #f0f0f0; border-radius:10px; padding:10px;}
    .k label{display:block; font-size:12px; color:var(--c-sub);} .k b{font-size:20px;}
    .eval-table{width:100%; border-collapse:collapse;}
    .eval-table th,.eval-table td{border-bottom:1px solid var(--c-border);
                                 padding:6px 8px; text-align:left;}
    .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff;}
    .chip.ok{background:var(--c-ok);} .chip.warn{background:var(--c-warn); color:#000;} .chip.bad{background:var(--c-bad);}
    .gallery{display:grid; grid-template-columns:repeat(3,1fr); gap:10px;}
    .gallery img{width:100%; height:180px; object-fit:cover; border-radius:8px;
                 border:1px solid var(--c-border); box-shadow:var(--shadow);}
    .warn{background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:10px;}
    .summary-top{background:#fff; border-left:5px solid var(--c-brand); padding:10px 12px;
                 border-radius:8px; box-shadow:var(--shadow);}

    /* ==== ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆç”¨ ==== */
    .report .rep-head{margin-bottom:8px; font-size:16px;}
    .report .rep-photo-wrap{ text-align:center; margin:12px 0;}
    .report .rep-photo-wrap img{ max-width:100%; max-height:280px; border:1px solid #eee; border-radius:8px; display:none; }
    .report .rep-photo-ph{ font-size:28px; color:#666; font-weight:700; }
    .report .rep-table{ width:100%; border-collapse:collapse; }
    .report .rep-table th,.report .rep-table td{ border-bottom:1px solid #eee; padding:6px 8px; text-align:left; }

    @media print{
      body{ background:#fff; }
      header,.topbar,.btn, .gallery, details{ display:none !important; }
      .card{ box-shadow:none; border:1px solid #ccc; }
      .report .rep-photo-wrap img{ max-height:400px; }
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <div class="topbar">
    <div class="row">
      <a href="./index.html">â† åœ°å›³ã¸æˆ»ã‚‹</a>
      <span class="pill" id="idPill"></span>
      <span class="pill" id="srcPill"></span>
    </div>
    <div class="row">
      <label>ç”¨é€”</label>
      <select id="landuse">
        <option value="paddy">æ°´ç”°</option>
        <option value="upland">ç•‘</option>
      </select>
      <button class="btn" id="prevBtn">â† å‰ã¸</button>
      <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      <button class="btn" id="copyLinkBtn">ğŸ”— ã‚³ãƒ”ãƒ¼</button>
      <button class="btn" id="editToggle">ç·¨é›†</button>
      <button class="btn primary" id="saveBtn" style="display:none;">ä¿å­˜</button>
    </div>
  </div>

  <!-- æœ€ä¸Šéƒ¨ï¼šå›ºå®šèª¬æ˜ãªã© -->
  <div id="summaryTop" class="summary-top" style="display:none; margin-bottom:12px;"></div>

  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <h1 id="fieldName" style="margin:6px 0;"></h1>
  <div id="location" class="muted"></div>

  <!-- ãƒãƒƒã‚¸ -->
  <div style="margin-top:10px;">
    <span class="badge" id="rankBadge"></span>
    <span class="badge" style="background:#4caf50;">soil_pointså‚ç…§</span>
  </div>

  <!-- ä¸€è¨€ -->
  <p id="oneLine" style="font-weight:700; margin-top:10px;"></p>

  <!-- KPI -->
  <div class="card">
    <h2>ä¸»è¦æŒ‡æ¨™</h2>
    <div class="kpi">
      <div class="k"><label>EC</label><b id="kEC">-</b></div>
      <div class="k"><label>pH</label><b id="kpH">-</b></div>
      <div class="k"><label>CEC</label><b id="kCEC">-</b></div>
      <div class="k"><label>C/Næ¯”</label><b id="kCN">-</b></div>
      <div class="k"><label>å¾®ç”Ÿç‰©å¤šæ§˜æ€§</label><b id="kBio">-</b></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btn" id="copyCoordBtn">ğŸ“ åº§æ¨™ã‚³ãƒ”ãƒ¼</button>
      <button class="btn" id="downloadJsonBtn">â¬‡ JSON</button>
      <button class="btn" id="downloadCsvBtn">â¬‡ CSV</button>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢ -->
  <div class="card" style="margin-top:12px;">
    <h2>ãƒ¡ãƒ¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</h2>
    <div id="memoView">
      <div><b>å›ºå®šèª¬æ˜ï¼š</b><span id="fixedDescView"></span></div>
      <div><b>è©•ä¾¡ï¼š</b><span id="evalView"></span></div>
      <div><b>ä¸»ãªèª²é¡Œï¼š</b><span id="issueView"></span></div>
      <div><b>æ”¹å–„ç­–ï¼š</b><span id="solutionView"></span></div>
    </div>
    <div id="memoEdit" style="display:none; margin-top:10px;">
      <div style="margin-bottom:8px;">
        <div style="font-weight:700; margin-bottom:4px;">å›ºå®šèª¬æ˜</div>
        <input type="text" id="fixedDescInput" placeholder="ä¾‹ï¼šåœ°å½¢ãƒ»åœŸåœ°åˆ©ç”¨ã®èª¬æ˜ãªã©">
      </div>
      <div style="margin-bottom:8px;">
        <div style="font-weight:700; margin-bottom:4px;">è©•ä¾¡</div>
        <input type="text" id="evalInput" placeholder="ä¾‹ï¼šè‰¯ / æ™®é€š / è¦æ”¹å–„">
      </div>
      <div style="margin-bottom:8px;">
        <div style="font-weight:700; margin-bottom:4px;">ä¸»ãªèª²é¡Œ</div>
        <textarea id="issueInput" rows="3" placeholder="ä¸»ãªèª²é¡Œã‚’è¨˜å…¥"></textarea>
      </div>
      <div>
        <div style="font-weight:700; margin-bottom:4px;">æ”¹å–„ç­–</div>
        <textarea id="solutionInput" rows="3" placeholder="æ”¹å–„ç­–ã‚’è¨˜å…¥"></textarea>
      </div>
    </div>
  </div>

  <!-- æ¨™æº–å€¤ã¨ã®æ¯”è¼ƒï¼ˆæ—¢å­˜ã®åˆ¤å®šè¡¨ï¼‰ -->
  <div class="card" style="margin-top:12px;">
    <h2>æ¨™æº–å€¤ã¨ã®æ¯”è¼ƒ</h2>
    <table class="eval-table" id="evalTable">
      <thead>
        <tr><th>é …ç›®</th><th>å€¤</th><th>æ¨™æº–</th><th>åˆ¤å®š</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <div id="sourcesBox" class="muted" style="margin-top:8px;"></div>
  </div>

  <!-- â˜… ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆï¼ˆå ´æ‰€åï¼å†™çœŸï¼çµæœï½œæ¨™æº–ï¼‰ -->
  <div id="simpleReport" class="card report" style="margin-top:12px;">
    <h2>ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆ</h2>
    <div class="rep-head">
      <div><b>å ´æ‰€åï¼š</b><span id="repPlace"></span></div>
    </div>
    <div class="rep-photo-wrap">
      <img id="repPhoto" alt="å†™çœŸ" />
      <div id="repPhotoPh" class="rep-photo-ph">å†™çœŸ</div>
    </div>
    <table class="rep-table">
      <thead>
        <tr><th>é …ç›®</th><th>çµæœ</th><th>æ¨™æº–å€¤ï¼ˆJAç­‰ï¼‰</th></tr>
      </thead>
      <tbody id="repTbody"></tbody>
    </table>
    <div class="rep-source muted" id="repSource" style="margin-top:8px;"></div>
    <div class="row" style="margin-top:8px;">
      <button class="btn" onclick="window.print()">ğŸ–¨ å°åˆ·</button>
    </div>
  </div>

  <!-- ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ -->
  <div class="card" style="margin-top:12px;">
    <h2>ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆimage/ï¼‰</h2>
    <div id="gallery" class="gallery"></div>
    <div id="galleryNote" class="muted" style="margin-top:6px;"></div>
  </div>

  <!-- å…¨å±æ€§ -->
  <details>
    <summary>ğŸ”¬ soil_points ã®å±æ€§ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰</summary>
    <div id="analysisWrap"></div>
  </details>

  <script>
    /* Utility */
    const $ = id => document.getElementById(id);
    const num = x => { const n = Number(x); return Number.isFinite(n) ? n : NaN; };
    const fmt = (v, d=2) => Number.isFinite(v) ? v.toFixed(d) : "â€”";
    async function copyText(t){ try{await navigator.clipboard.writeText(t);}catch{} }
    function jsonToCsv(obj){
      const keys=Object.keys(obj);
      const vals=keys.map(k=>`"${String(obj[k]??"").replace(/"/g,'""')}"`);
      return keys.join(",")+"\n"+vals.join(",")+"\n";
    }
    function downloadBlob(name, text){
      const blob=new Blob([text],{type:"text/plain"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob); a.download=name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),500);
    }

    /* URL params â˜… decodeãƒ‘ãƒƒãƒ */
    const params = new URLSearchParams(location.search);
    const pointId = params.get("id");
    const src = (() => {
      const raw = params.get("src");
      return raw ? decodeURIComponent(raw) : "data/Saitama/Chichibu/Oota/soil_points.geojson";
    })();

    $("idPill").textContent = `ID: ${pointId ?? "-"}`;
    $("srcPill").textContent = `src: ${src}`;

    /* State */
    let featureList=[]; let currentIndex=-1;
    let STANDARDS=null; let SOURCES=[];

    // ==== æ¨™æº–ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆï¼ˆæ¨™æº–åˆ—ï¼‰ ====
    function stdTextOf(k, std){
      if(!std || !std[k]) return "â€”";
      const s=std[k];
      if (k==="ph")     return `è‰¯:${s.ok?.[0]}ã€œ${s.ok?.[1]} / æ³¨æ„:${s.warn?.[0]}ã€œ${s.warn?.[1]}`;
      if (k==="ec")     return `è‰¯:â‰¤${s.ok_max} / æ³¨æ„:â‰¤${s.warn_max}`;
      if (k==="cec")    return `è‰¯:â‰¥${s.ok_min} / æ³¨æ„:â‰¥${s.warn_min}`;
      if (k==="cn")     return `è‰¯:${s.ok?.[0]}ã€œ${s.ok?.[1]} / æ³¨æ„:${s.warn?.[0]}ã€œ${s.warn?.[1]}`;
      if (k==="om")     return `è‰¯:â‰¥${s.ok_min} / æ³¨æ„:â‰¥${s.warn_min}`;
      if (k==="biotex") return `è‰¯:â‰¥${s.ok_min} / æ³¨æ„:â‰¥${s.warn_min}`;
      return "â€”";
    }

    // ãƒ¬ãƒãƒ¼ãƒˆç”¨ã‚‚ã“ã®é–¢æ•°ã‚’ä½¿ã†
    const stdTextFor = (k, std) => stdTextOf(k, std);

    // ==== èµ·å‹• ====
    main();

    async function main(){
      if(!pointId){
        document.body.innerHTML="<div class='warn'>ID ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>"; return;
      }
      // standards
      try{
        const s=await fetch("data/standard_data/standards.json",{cache:"no-store"});
        if(s.ok){
          const j=await s.json();
          STANDARDS=j;
          SOURCES=j.sources||[];
          // æ—¢å®šç”¨é€”ï¼ˆstandards.json ã® meta.default_landuse ã‚’å°Šé‡ï¼‰
          $("landuse").value = j?.meta?.default_landuse || "paddy";
        }
      }catch{}

      // GeoJSON
      try{
        const r=await fetch(src,{cache:"no-store"});
        if(!r.ok) throw new Error(r.status+" "+r.statusText);
        const fc=await r.json();
        featureList=fc.features||[];
      }catch(e){
        document.body.innerHTML = `<div class='warn'>GeoJSON ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼š<code>${src}</code><br>${String(e)}</div>`;
        return;
      }

      currentIndex=featureList.findIndex(f=>String(f?.properties?.field_id)===String(pointId));
      if(currentIndex<0){
        document.body.innerHTML=`<div class='warn'>ID <code>${pointId}</code> ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>`; return;
      }

      $("prevBtn").onclick=()=>{
        if(currentIndex>0){
          const fid=featureList[currentIndex-1].properties.field_id;
          location.href=`soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
        }
      };
      $("nextBtn").onclick=()=>{
        if(currentIndex<featureList.length-1){
          const fid=featureList[currentIndex+1].properties.field_id;
          location.href=`soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
        }
      };
      $("copyLinkBtn").onclick=()=>copyText(location.href);
      $("landuse").onchange=()=>render(featureList[currentIndex]);

      render(featureList[currentIndex]);
    }

    function getStd(){
      const lu=$("landuse").value;
      return STANDARDS?.standards?.[lu] || null;
    }

    function addRow(tbody, label, v, stdText, judge){
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${label}</td>
        <td>${v ?? "â€”"}</td>
        <td>${stdText || "â€”"}</td>
        <td><span class="chip ${judge.class||""}">${judge.label}</span></td>
        <td>${judge.comment||""}</td>`;
      tbody.appendChild(tr);
    }

    function judgeRange(value, std, type){
      if(!Number.isFinite(value)) return {label:"â€”", class:"", comment:"å€¤ãªã—"};
      if(!std) return {label:"â€”", class:"", comment:"åŸºæº–ãªã—"};
      if(type==="ph"){
        const ok=std.ok||[5.5,6.5], w=std.warn||[5.0,7.5];
        if(value>=ok[0] && value<=ok[1]) return {label:"è‰¯",class:"ok",comment:"é©æ­£"};
        if(value>=w[0] && value<=w[1]) return {label:"æ³¨æ„",class:"warn",comment:"ã‚„ã‚„å¤–ã‚Œ"};
        return {label:"è¦æ”¹å–„",class:"bad",comment:"é©æ­£åŸŸå¤–"};
      }
      if(type==="ec"){
        const o=std.ok_max??0.5, w=std.warn_max??0.8;
        if(value<=o) return {label:"è‰¯",class:"ok",comment:"æ­£å¸¸"};
        if(value<=w) return {label:"æ³¨æ„",class:"warn",comment:"ã‚„ã‚„é«˜ã„"};
        return {label:"è¦æ”¹å–„",class:"bad",comment:"é«˜ã„"};
      }
      if(type==="cec"){
        const o=std.ok_min??10, w=std.warn_min??8;
        if(value>=o) return {label:"è‰¯",class:"ok",comment:"ååˆ†"};
        if(value>=w) return {label:"æ³¨æ„",class:"warn",comment:"ã‚„ã‚„ä½ã„"};
        return {label:"è¦æ”¹å–„",class:"bad",comment:"ä½ã„"};
      }
      if(type==="biotex"){
        const okMin = std.ok_min ?? 700000, warnMin = std.warn_min ?? 300000;
        if(value>=okMin)  return {label:"è‰¯", class:"ok",   comment:"ç”Ÿç‰©æ€§ã¯è‰¯å¥½"};
        if(value>=warnMin)return {label:"æ³¨æ„", class:"warn", comment:"å¹³å‡ã€œã‚„ã‚„å¼±ã„ã€‚åœŸã¥ãã‚Šã§åº•ä¸Šã’"};
        return {label:"è¦æ”¹å–„", class:"bad",  comment:"å¼±ã„ã€‚è¢«è¦†ä½œç‰©/æœ‰æ©Ÿç‰©ã®è¨ˆç”»æŠ•å…¥ã‚’"};
      }
      return {label:"â€”",class:"",comment:""};
    }

    function dirOf(url){
      const u = decodeURIComponent(url);
      return u.substring(0, u.lastIndexOf("/"));
    }
    function guessImages(baseDir, fid){
      const exts=["png","jpg","jpeg","webp"];
      const out=[];
      exts.forEach(e=>out.push(`${baseDir}/image/${fid}.${e}`));
      for(let i=1;i<=6;i++) exts.forEach(e=>out.push(`${baseDir}/image/${fid}_${i}.${e}`));
      for(let i=1;i<=6;i++) exts.forEach(e=>out.push(`${baseDir}/image/${fid}-${i}.${e}`));
      return out;
    }

    async function render(f){
      const p=f.properties||{};
      const [lon,lat]=f.geometry?.coordinates||[];

      // æœ€ä¸Šéƒ¨èª¬æ˜
      let topNote = p["æœ€çµ‚åœ°ç‚¹ã®èª¬æ˜"] || p["å›ºå®šèª¬æ˜"] || "";
      if(!topNote){
        try{
          const r=await fetch("data/standard_data/field_notes.json",{cache:"no-store"});
          if(r.ok){ const notes=await r.json(); topNote = notes[p.field_id] || ""; }
        }catch{}
      }
      if(topNote){ $("summaryTop").style.display="block"; $("summaryTop").textContent=topNote; }

      $("fieldName").textContent = p.field_id || pointId;
      $("location").textContent  = p["å ´æ‰€å"] || "";

      // KPI
      const CN=(Number.isFinite(num(p.C)) && Number.isFinite(num(p.N)) && num(p.N)!==0) ? num(p.C)/num(p.N) : NaN;
      $("kEC").textContent  = p.EC ?? "-";
      $("kpH").textContent  = p.pH ?? "-";
      $("kCEC").textContent = p.CEC ?? "-";
      $("kCN").textContent  = Number.isFinite(CN)?fmt(CN,1):"-";
      $("kBio").textContent = p["åœŸå£Œå¾®ç”Ÿç‰©å¤šæ§˜æ€§ãƒ»æ´»æ€§å€¤(BIOTREX)"] ?? "-";

      $("oneLine").textContent = "æ¸¬å®šå€¤ã«åŸºã¥ãç®¡ç†æ–¹é‡ã‚’æ¤œè¨ã§ãã¾ã™ã€‚";

      // ãƒ¡ãƒ¢
      const memoKey=`soilMemo:${src}#${p.field_id||pointId}`;
      const memo=(()=>{ try{ return JSON.parse(localStorage.getItem(memoKey)||"{}"); }catch{return{}} })();
      $("fixedDescView").textContent=memo.fixedDesc||"ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("evalView").textContent     =memo.evalTxt||"ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("issueView").textContent    =memo.issue||"ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("solutionView").textContent =memo.solution||"ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("fixedDescInput").value=memo.fixedDesc||"";
      $("evalInput").value=memo.evalTxt||"";
      $("issueInput").value=memo.issue||"";
      $("solutionInput").value=memo.solution||"";
      let editing=false;
      $("editToggle").onclick=()=>{
        editing=!editing;
        $("memoEdit").style.display=editing?"block":"none";
        $("saveBtn").style.display=editing?"inline-block":"none";
        $("editToggle").textContent=editing?"é–²è¦§":"ç·¨é›†";
      };
      $("saveBtn").onclick=()=>{
        const m={ fixedDesc:$("fixedDescInput").value, evalTxt:$("evalInput").value,
                  issue:$("issueInput").value,      solution:$("solutionInput").value };
        localStorage.setItem(memoKey, JSON.stringify(m));
        render(f);
      };

      // ===== æ¨™æº–ï¼ˆæ—¢å­˜è¡¨ï¼‰ =====
      const std = getStd();
      const tbody = $("evalTable").querySelector("tbody"); tbody.innerHTML="";
      const usedSourceIds = new Set();

      function stdTextAndUse(k){
        if(!std || !std[k]) return "â€”";
        const s=std[k]; if (s.source) usedSourceIds.add(s.source);
        return stdTextOf(k, std);
      }

      addRow(tbody,"EC (dS/m)",        p.EC,  stdTextAndUse("ec"),    judgeRange(num(p.EC),  std?.ec,  "ec"));
      addRow(tbody,"pH",               p.pH,  stdTextAndUse("ph"),    judgeRange(num(p.pH),  std?.ph,  "ph"));
      addRow(tbody,"CEC (me/100g)",    p.CEC, stdTextAndUse("cec"),   judgeRange(num(p.CEC), std?.cec, "cec"));
      addRow(tbody,"C (%)",            p.C,   "â€”",                    {label:"â€”",class:"",comment:"å‚è€ƒè¡¨ç¤º"});
      addRow(tbody,"N (%)",            p.N,   "â€”",                    {label:"â€”",class:"",comment:"å‚è€ƒè¡¨ç¤º"});
      addRow(tbody,"C/N æ¯”",           Number.isFinite(CN)?fmt(CN,1):"â€”", stdTextAndUse("cn"),    {label:"â€”",class:"",comment:"C,Nã®å‚è€ƒã¨ä½µèª­"});
      addRow(tbody,"æœ‰æ©Ÿç‰©é‡",         p["æœ‰æ©Ÿç‰©é‡"], stdTextAndUse("om"), {label:"â€”",class:"",comment:"å‚è€ƒ"});
      const biotex = num(p["åœŸå£Œå¾®ç”Ÿç‰©å¤šæ§˜æ€§ãƒ»æ´»æ€§å€¤(BIOTREX)"]);
      addRow(tbody,"å¾®ç”Ÿç‰©å¤šæ§˜æ€§(BIOTREX)", Number.isFinite(biotex)?biotex:"â€”", stdTextAndUse("biotex"), judgeRange(biotex, std?.biotex, "biotex"));

      // ãƒ©ãƒ³ã‚¯ï¼ˆç°¡æ˜“ï¼šECãƒ™ãƒ¼ã‚¹ï¼‰
      const evEc = judgeRange(num(p.EC), std?.ec, "ec");
      const rank = evEc.label==="è‰¯" ? "A" : (evEc.label==="æ³¨æ„" ? "B" : "C");
      const rankBadge = $("rankBadge");
      rankBadge.textContent = `${rank}ãƒ©ãƒ³ã‚¯ï¼ˆä»®ï¼‰`;
      rankBadge.style.background = (rank==="A"?"#4caf50":rank==="B"?"#ffb300":"#e53935");

      // å‡ºå…¸è¡¨ç¤ºï¼ˆä½¿ç”¨ã•ã‚ŒãŸ source ã®ã¿ï¼‰
      const box=$("sourcesBox");
      if (SOURCES && usedSourceIds.size){
        const html=[...usedSourceIds].map(id=>{
          const s=SOURCES.find(x=>x.id===id);
          return s ? `ãƒ»<a href="${s.url}" target="_blank" rel="noopener">${s.title}ï¼ˆ${s.publisher}ï¼‰</a>` : "";
        }).filter(Boolean).join("<br>");
        box.innerHTML = `<div>åŸºæº–å‡ºå…¸ï¼š</div>${html}`;
      } else {
        box.textContent = "åŸºæº–å‡ºå…¸ï¼šstandards.jsonï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰";
      }

      // ä¾¿åˆ©ãƒœã‚¿ãƒ³
      $("copyCoordBtn").onclick = ()=>copyText(`${lat}, ${lon}`);
      $("downloadJsonBtn").onclick = ()=>downloadBlob(`soil_${p.field_id||pointId}.json`, JSON.stringify(p,null,2));
      $("downloadCsvBtn").onclick  = ()=>downloadBlob(`soil_${p.field_id||pointId}.csv`, jsonToCsv(p));

      // å…¨å±æ€§
      const wrap=$("analysisWrap"); wrap.innerHTML="";
      wrap.appendChild((()=>{
        const table=document.createElement("table"); table.className="eval-table";
        const thead=document.createElement("thead"); thead.innerHTML="<tr><th>ã‚­ãƒ¼</th><th>å€¤</th></tr>";
        const tb=document.createElement("tbody");
        Object.entries(p).forEach(([k,v])=>{
          const tr=document.createElement("tr");
          tr.innerHTML=`<td>${k}</td><td>${v==null?"":String(v)}</td>`;
          tb.appendChild(tr);
        });
        table.append(thead,tb); return table;
      })());

      // ç”»åƒï¼ˆã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼‰
      const baseDir = dirOf(src);
      const gallery = $("gallery"); gallery.innerHTML="";
      const note=$("galleryNote"); note.textContent="";
      let imgs=[];
      if (Array.isArray(p.images) && p.images.length){
        imgs = p.images.map(u => u.match(/^https?:\/\//) ? u : `${baseDir}/${u.replace(/^\.?\//,"")}`);
      } else if (typeof p.images==="string" && p.images.trim()){
        imgs = p.images.split(",").map(s=>s.trim()).filter(Boolean)
               .map(u => u.match(/^https?:\/\//) ? u : `${baseDir}/${u.replace(/^\.?\//,"")}`);
      } else {
        imgs = guessImages(baseDir, p.field_id||pointId);
      }
      let shown=0;
      imgs.forEach(u=>{
        const img=new Image(); img.loading="lazy"; img.alt=p.field_id||""; img.src=u;
        img.onerror=()=>{ img.style.display="none"; };
        img.onload =()=>{ shown++; };
        img.onclick=()=>window.open(u,"_blank","noopener");
        gallery.appendChild(img);
      });
      setTimeout(()=>{ if (shown===0) note.textContent="ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚„ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆimage/ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"; }, 800);

      // ===== ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆ =====
      try{
        // 1) å ´æ‰€å
        $("repPlace").textContent = p["å ´æ‰€å"] || "";

        // 2) å†™çœŸï¼ˆ1æšï¼‰
        const photoEl = $("repPhoto");
        const phEl    = $("repPhotoPh");
        let repSrc = null;
        if (Array.isArray(p.images) && p.images.length){
          repSrc = p.images[0].match(/^https?:\/\//) ? p.images[0] : `${baseDir}/${p.images[0].replace(/^\.?\//,"")}`;
        } else {
          const candidates = guessImages(baseDir, p.field_id||pointId);
          repSrc = candidates[0];
        }
        if (repSrc){
          const testImg = new Image();
          testImg.onload = ()=>{ photoEl.src = repSrc; photoEl.style.display="inline-block"; phEl.style.display="none"; };
          testImg.onerror = ()=>{ photoEl.style.display="none"; phEl.style.display="block"; };
          testImg.src = repSrc;
        } else {
          photoEl.style.display="none"; phEl.style.display="block";
        }

        // 3) çµæœï½œæ¨™æº–
        const repStd = getStd();
        const repTb  = $("repTbody"); repTb.innerHTML="";
        const CNrep = (Number.isFinite(num(p.C)) && Number.isFinite(num(p.N)) && num(p.N)!==0) ? (num(p.C)/num(p.N)) : null;

        function addRepRow(tbody, label, value, stdKey){
          const tr = document.createElement("tr");
          const v  = (value==null || value==="") ? "â€”" : String(value);
          tr.innerHTML = `<td>${label}</td><td>${v}</td><td>${stdTextOf(stdKey, repStd)}</td>`;
          tbody.appendChild(tr);
        }

        addRepRow(repTb, "EC (dS/m)", p.EC,  "ec");
        addRepRow(repTb, "pH",        p.pH,  "ph");
        addRepRow(repTb, "CEC (me/100g)", p.CEC, "cec");
        addRepRow(repTb, "C (%)",     p.C,   null);
        addRepRow(repTb, "N (%)",     p.N,   null);
        addRepRow(repTb, "C/N æ¯”",    Number.isFinite(CNrep)?CNrep.toFixed(1):"â€”", "cn");
        addRepRow(repTb, "æœ‰æ©Ÿç‰©é‡",  p["æœ‰æ©Ÿç‰©é‡"], "om");
        addRepRow(repTb, "å¾®ç”Ÿç‰©å¤šæ§˜æ€§(BIOTREX)", p["åœŸå£Œå¾®ç”Ÿç‰©å¤šæ§˜æ€§ãƒ»æ´»æ€§å€¤(BIOTREX)"], "biotex");

        // 4) å‡ºå…¸ï¼ˆè¡¨ã§ä½¿ã‚ã‚ŒãŸã‚­ãƒ¼ã® source ã‚’é›†ç´„ï¼‰
        const used = new Set();
        ["ph","ec","cec","cn","om","biotex"].forEach(k=>{ const id=repStd?.[k]?.source; if(id) used.add(id); });
        $("repSource").innerHTML = (SOURCES && used.size)
          ? [...used].map(id=>{ const s=SOURCES.find(x=>x.id===id); return s ? `ãƒ»<a href="${s.url}" target="_blank" rel="noopener">${s.title}ï¼ˆ${s.publisher}ï¼‰</a>`:""; }).filter(Boolean).join("<br>")
          : "";
      }catch(e){ console.warn("ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã§è­¦å‘Š:", e); }

    } // render
  </script>
</body>
</html>