<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>åœŸå£Œè¨ºæ–­çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Chart.jsï¼ˆãƒ¬ãƒ¼ãƒ€ãƒ¼/æ£’ã‚°ãƒ©ãƒ•ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --c-brand:#0a66c2;
      --c-text:#333;
      --c-sub:#555;
      --c-muted:#888;
      --c-border:#eee;
      --c-bg:#fff;
      --c-chip:#eef2ff;
      --c-ok:#4caf50;
      --c-warn:#ffb300;
      --c-bad:#e53935;
      --shadow:0 2px 8px rgba(0,0,0,.06);
      --radius:12px;
    }
    html,body{margin:0;padding:0}
    body{
      font-family:system-ui, -apple-system, "Segoe UI", sans-serif;
      line-height:1.7; padding:16px; max-width:1100px; margin:0 auto;
      color:var(--c-text); background:#f7f7f8;
    }
    a{color:var(--c-brand); text-decoration:none;}
    a:hover{text-decoration:underline;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .topbar{display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap;}
    .pill{display:inline-flex; align-items:center; gap:6px; background:#f1f3f5; border-radius:999px; padding:2px 10px; font-size:12px; color:var(--c-sub);}
    .btn{border:1px solid #ddd; background:#fafafa; padding:6px 10px; border-radius:8px; cursor:pointer;}
    .btn:hover{background:#f0f0f0;}
    .btn.primary{border-color:var(--c-brand); background:var(--c-brand); color:#fff;}
    .btn.icon{display:inline-flex; align-items:center; gap:6px;}
    .badge{display:inline-block; color:#fff; padding:4px 12px; border-radius:6px; margin-right:6px; font-weight:700; font-size:13px;}
    .muted{color:var(--c-muted);}

    .card{background:var(--c-bg); border:1px solid var(--c-border); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);}
    .card h2{font-size:16px; margin:0 0 10px;}
    .grid{display:grid; grid-template-columns:1.3fr 1fr; gap:14px;}
    @media (max-width: 900px){ .grid{ grid-template-columns:1fr; } }

    .kpi{display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;}
    @media (max-width: 900px){ .kpi{ grid-template-columns:1fr 1fr 1fr; } }
    .k{background:#f9f9fb; border:1px solid #f0f0f0; border-radius:10px; padding:10px;}
    .k label{display:block; font-size:12px; color:var(--c-sub);}
    .k b{font-size:20px;}

    .charts{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
    @media (max-width: 900px){ .charts{ grid-template-columns:1fr; } }

    .eval-table{width:100%; border-collapse:collapse;}
    .eval-table th,.eval-table td{border-bottom:1px solid var(--c-border); padding:6px 8px; text-align:left;}
    .chip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff;}
    .chip.ok{background:var(--c-ok);}
    .chip.warn{background:var(--c-warn); color:#000;}
    .chip.bad{background:var(--c-bad);}

    details{margin-top:10px; background:#fafafa; padding:10px; border-radius:12px; border:1px solid var(--c-border);}
    table.meta{border-collapse:collapse; width:100%;}
    table.meta th, table.meta td{border-bottom:1px solid var(--c-border); padding:6px 8px; vertical-align:top;}
    table.meta th{width:220px; text-align:left; white-space:nowrap; color:var(--c-sub); font-weight:600;}

    .gallery{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    @media (max-width: 900px){ .gallery{ grid-template-columns:repeat(2, 1fr);} }
    .gallery img{width:100%; height:180px; object-fit:cover; border-radius:8px; border:1px solid var(--c-border); box-shadow:var(--shadow); background:#fff;}
    .warn{background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:10px;}
    .toolbar .spacer{flex:1}
  </style>
</head>
<body>

  <!-- Top -->
  <div class="topbar">
    <div class="row">
      <a href="./index.html">â† åœ°å›³ã¸æˆ»ã‚‹</a>
      <span class="pill" id="idPill"></span>
      <span class="pill" id="srcPill"></span>
    </div>
    <div class="row toolbar">
      <label>ç”¨é€”</label>
      <select id="landuse">
        <option value="paddy">æ°´ç”°</option>
        <option value="upland">ç•‘</option>
      </select>
      <span class="spacer"></span>
      <button class="btn" id="prevBtn">â† å‰ã¸</button>
      <button class="btn" id="nextBtn">æ¬¡ã¸ â†’</button>
      <button class="btn" id="copyLinkBtn" title="ã“ã®è¨ºæ–­ãƒšãƒ¼ã‚¸URLã‚’ã‚³ãƒ”ãƒ¼">ğŸ”— ã‚³ãƒ”ãƒ¼</button>
      <button class="btn" id="editToggle">ç·¨é›†</button>
      <button class="btn primary" id="saveBtn" style="display:none;">ä¿å­˜</button>
    </div>
  </div>

  <!-- Title -->
  <h1 id="fieldName" style="margin:6px 0;"></h1>
  <div id="location" class="muted"></div>

  <!-- Badges -->
  <div style="margin-top:10px;">
    <span class="badge" id="rankBadge"></span>
    <span class="badge" style="background:var(--c-ok);">soil_pointså‚ç…§</span>
  </div>

  <!-- One line -->
  <p id="oneLine" style="font-weight:700; margin-top:10px;"></p>

  <!-- KPIs + Tools -->
  <div class="card">
    <h2>ä¸»è¦æŒ‡æ¨™</h2>
    <div class="kpi">
      <div class="k"><label>EC</label><b id="kEC">-</b></div>
      <div class="k"><label>pH</label><b id="kpH">-</b></div>
      <div class="k"><label>CEC</label><b id="kCEC">-</b></div>
      <div class="k"><label>æ¡å–æ—¥</label><b id="kDate" style="font-size:14px;">-</b></div>
      <div class="k"><label>åº§æ¨™</label><b id="kCoord" style="font-size:14px;">-</b></div>
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="btn icon" id="copyCoordBtn">ğŸ“ åº§æ¨™ã‚³ãƒ”ãƒ¼</button>
      <button class="btn icon" id="downloadJsonBtn">â¬‡ JSON</button>
      <button class="btn icon" id="downloadCsvBtn">â¬‡ CSV</button>
    </div>
  </div>

  <!-- Charts + Memo -->
  <div class="grid" style="margin-top:12px;">
    <div class="card">
      <h2>ãƒãƒ£ãƒ¼ãƒˆ</h2>
      <div class="charts">
        <canvas id="radarChart" height="260"></canvas>
        <canvas id="barChart" height="260"></canvas>
      </div>
    </div>

    <div class="card">
      <h2>ãƒ¡ãƒ¢ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰</h2>
      <div id="memoView">
        <div><b>å›ºå®šèª¬æ˜ï¼š</b><span id="fixedDescView"></span></div>
        <div><b>è©•ä¾¡ï¼š</b><span id="evalView"></span></div>
        <div><b>ä¸»ãªèª²é¡Œï¼š</b><span id="issueView"></span></div>
        <div><b>æ”¹å–„ç­–ï¼š</b><span id="solutionView"></span></div>
      </div>

      <div id="memoEdit" style="display:none; margin-top:10px;">
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">å›ºå®šèª¬æ˜</div>
          <input type="text" id="fixedDescInput" placeholder="ä¾‹ï¼šåœ°å½¢ãƒ»åœŸåœ°åˆ©ç”¨ã®èª¬æ˜ãªã©">
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">è©•ä¾¡</div>
          <input type="text" id="evalInput" placeholder="ä¾‹ï¼šè‰¯ / æ™®é€š / è¦æ”¹å–„ ãªã©">
        </div>
        <div style="margin-bottom:8px;">
          <div style="font-weight:700; margin-bottom:4px;">ä¸»ãªèª²é¡Œ</div>
          <textarea id="issueInput" rows="3" placeholder="ä¸»ãªèª²é¡Œã‚’è¨˜å…¥"></textarea>
        </div>
        <div>
          <div style="font-weight:700; margin-bottom:4px;">æ”¹å–„ç­–</div>
          <textarea id="solutionInput" rows="3" placeholder="æ”¹å–„ç­–ã‚’è¨˜å…¥"></textarea>
        </div>
      </div>
      <small class="muted">â€» ãƒ¡ãƒ¢ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨IDã§ç´ã¥ã‘ï¼‰</small>
    </div>
  </div>

  <!-- Evaluation table -->
  <div class="card" style="margin-top:12px;">
    <h2>æ¨™æº–å€¤ã¨ã®æ¯”è¼ƒï¼ˆæš«å®šåŸºæº–ï¼‰</h2>
    <table class="eval-table" id="evalTable">
      <thead>
        <tr><th>é …ç›®</th><th>å€¤</th><th>æ¨™æº–ï¼ˆç›®å®‰ï¼‰</th><th>åˆ¤å®š</th><th>ã‚³ãƒ¡ãƒ³ãƒˆ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <details style="margin-top:8px;">
      <summary>åŸºæº–ã‚’ç·¨é›†ï¼ˆã“ã®ãƒšãƒ¼ã‚¸å†…ã®ã¿åæ˜ ï¼‰</summary>
      <div class="row" style="margin-top:8px;">
        <div>EC è‰¯: â‰¤ <input id="std_ec_ok" type="number" step="0.01" style="width:80px"> / æ³¨æ„: â‰¤ <input id="std_ec_warn" type="number" step="0.01" style="width:80px"></div>
      </div>
      <div class="row">
        <div>pH è‰¯: <input id="std_ph_ok_lo" type="number" step="0.1" style="width:80px">ã€œ<input id="std_ph_ok_hi" type="number" step="0.1" style="width:80px"> / æ³¨æ„å¹…: <input id="std_ph_warn_lo" type="number" step="0.1" style="width:80px">ã€œ<input id="std_ph_warn_hi" type="number" step="0.1" style="width:80px"></div>
      </div>
      <div class="row">
        <div>CEC è‰¯: â‰¥ <input id="std_cec_ok" type="number" step="1" style="width:80px"> / æ³¨æ„: â‰¥ <input id="std_cec_warn" type="number" step="1" style="width:80px"></div>
      </div>
      <div class="row"><button class="btn primary" id="applyStdBtn">åŸºæº–ã‚’é©ç”¨</button></div>
      <small class="muted">â€»å­¦è¡“çš„ãªå®šæ•°ã§ã¯ãªãã€é‹ç”¨ä¸Šã®æš«å®šç›®å®‰ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚</small>
    </details>
  </div>

  <!-- Gallery -->
  <div class="card" style="margin-top:12px;">
    <h2>ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
    <div id="gallery" class="gallery"></div>
    <div id="galleryNote" class="muted" style="margin-top:6px;"></div>
  </div>

  <!-- å…¨å±æ€§ -->
  <details>
    <summary>ğŸ”¬ soil_points ã®å±æ€§ï¼ˆã™ã¹ã¦è¡¨ç¤ºï¼‰</summary>
    <div id="analysisWrap"></div>
  </details>

  <script>
    /**********************
     * è¨­å®šï¼ˆæš«å®šç›®å®‰ã®æ—¢å®šå€¤ï¼‰
     **********************/
    const DEFAULT_STANDARDS = {
      paddy: { // æ°´ç”°
        ec:  { ok: 0.12, warn: 0.20 },          // EC[dS/m] è‰¯: â‰¤0.12, æ³¨æ„: â‰¤0.20, ãã‚Œä»¥ä¸Šã¯è¦æ”¹å–„
        ph:  { ok:[5.5, 6.5], warn:[5.0, 7.5] }, // pH è‰¯:5.5ã€œ6.5, æ³¨æ„:5.0ã€œ5.5 / 6.5ã€œ7.5
        cec: { ok: 10, warn: 8 }                 // CEC è‰¯:â‰¥10, æ³¨æ„:â‰¥8
      },
      upland: { // ç•‘
        ec:  { ok: 0.10, warn: 0.15 },
        ph:  { ok:[6.0, 7.0], warn:[5.5, 7.5] },
        cec: { ok: 10, warn: 8 }
      }
    };

    /**********************
     * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
     **********************/
    const $ = (id) => document.getElementById(id);
    const num = (x) => { const n = Number(x); return Number.isFinite(n) ? n : NaN; };
    function rankColor(rank, alpha=1){
      switch(rank){
        case "A": return `rgba(76,175,80,${alpha})`;
        case "B": return `rgba(255,193,7,${alpha})`;
        case "C": return `rgba(244,67,54,${alpha})`;
        default:  return `rgba(158,158,158,${alpha})`;
      }
    }
    function saveMemo(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }
    function loadMemo(key){ try{ const r=localStorage.getItem(key); return r?JSON.parse(r):{}; }catch{ return {}; } }
    async function copyText(text){
      try{ await navigator.clipboard.writeText(text); alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
      catch{ prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:", text); }
    }
    function renderPropsTable(props){
      const table = document.createElement("table");
      table.className = "meta";
      Object.entries(props || {}).forEach(([k,v])=>{
        const tr=document.createElement("tr");
        const th=document.createElement("th"); th.textContent=k;
        const td=document.createElement("td"); td.textContent = v==null ? "" : String(v);
        tr.append(th,td); table.append(tr);
      });
      return table;
    }
    function jsonToCsvRow(obj){
      const keys = Object.keys(obj);
      const vals = keys.map(k => {
        const v = obj[k];
        const t = (v==null) ? "" : String(v);
        return '"' + t.replace(/"/g,'""') + '"';
      });
      return keys.join(",") + "\n" + vals.join(",") + "\n";
    }
    function downloadBlob(filename, text, type="text/plain"){
      const blob = new Blob([text], {type});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    /**********************
     * è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯
     **********************/
    function evaluateValue(value, std, type){
      // æˆ»ã‚Š: {label: 'è‰¯/æ³¨æ„/è¦æ”¹å–„/â€”', class: 'ok/warn/bad', rangeText, comment}
      if (!Number.isFinite(value)) return { label:"â€”", class:"", rangeText:"â€”", comment:"å€¤ãªã—" };

      if (type === "ec"){
        const ok = std.ok, warn = std.warn;
        if (value <= ok)  return { label:"è‰¯", class:"ok",   rangeText:`â‰¤ ${ok}`,  comment:"å¡©é¡æ¿ƒåº¦ã¯å•é¡Œãªã„ç¯„å›²ã§ã™ã€‚`" };
        if (value <= warn)return { label:"æ³¨æ„", class:"warn",rangeText:`â‰¤ ${warn}`,comment:"ã‚„ã‚„é«˜ã‚ã€‚çŒæ¼‘ã‚„æ–½è‚¥ç®¡ç†ã®è¦‹ç›´ã—ã‚’æ¤œè¨ã€‚" };
        return { label:"è¦æ”¹å–„", class:"bad", rangeText:`> ${warn}`, comment:"é«˜ã‚ã€‚æ–½è‚¥é‡/æ’å¡©/çŒæ¼‘ã®è¦‹ç›´ã—ãŒå¿…è¦ã€‚" };
      }

      if (type === "ph"){
        const [okLo, okHi] = std.ok;
        const [wLo,  wHi ] = std.warn;
        if (value >= okLo && value <= okHi)
          return { label:"è‰¯", class:"ok", rangeText:`${okLo}ã€œ${okHi}`, comment:"é©æ­£åŸŸå†…ã§ã™ã€‚" };
        if ((value >= wLo && value < okLo) || (value > okHi && value <= wHi))
          return { label:"æ³¨æ„", class:"warn", rangeText:`${wLo}ã€œ${okLo} / ${okHi}ã€œ${wHi}`, comment:"ã‚„ã‚„å¤–ã‚Œã€‚çŸ³ç°/ç¡«é»„ç­‰ã®çŸ¯æ­£è³‡æã‚’æ¤œè¨ã€‚" };
        return { label:"è¦æ”¹å–„", class:"bad", rangeText:`< ${wLo} / > ${wHi}`, comment:"é©æ­£åŸŸå¤–ã€‚çŸ¯æ­£è³‡æã¨ç®¡ç†ã®è¦‹ç›´ã—ãŒå¿…è¦ã€‚" };
      }

      if (type === "cec"){
        const ok = std.ok, warn = std.warn;
        if (value >= ok)  return { label:"è‰¯", class:"ok",   rangeText:`â‰¥ ${ok}`,  comment:"ä¿è‚¥åŠ›ã¯ååˆ†ã§ã™ã€‚" };
        if (value >= warn)return { label:"æ³¨æ„", class:"warn",rangeText:`â‰¥ ${warn}`,comment:"ã‚„ã‚„ä½ã‚ã€‚æœ‰æ©Ÿç‰©æŠ•å…¥ç­‰ã®æ”¹å–„ã‚’æ¤œè¨ã€‚" };
        return { label:"è¦æ”¹å–„", class:"bad", rangeText:`< ${warn}`, comment:"ä½ã‚ã€‚å †è‚¥/ç·‘è‚¥ç­‰ã§ã®æ”¹å–„ãŒæœ‰åŠ¹ã€‚" };
      }

      return { label:"â€”", class:"", rangeText:"â€”", comment:"" };
    }

    function calcRankByEC(ec, landuseStd){
      if (!Number.isFinite(ec)) return "â€”";
      // ç°¡æ˜“ï¼šEC è‰¯â†’A, æ³¨æ„â†’B, è¦æ”¹å–„â†’C
      const ev = evaluateValue(ec, landuseStd.ec, "ec");
      if (ev.label === "è‰¯") return "A";
      if (ev.label === "æ³¨æ„") return "B";
      return "C";
    }

    function scoreRadar(p){ // 0..5ã‚¹ã‚±ãƒ¼ãƒ«
      const ec  = num(p.EC);
      const ph  = num(p.pH);
      const cec = num(p.CEC);
      const clamp = (x)=>Math.max(0, Math.min(5, x));
      const soil_health = clamp(Math.round(Number.isFinite(cec) ? (cec/10) : 2));
      const safety      = clamp(Number.isFinite(ph) ? ((ph>=6 && ph<=7.2)?5:3) : 3);
      const environment = clamp(Number.isFinite(ec) ? ((ec>=0.12)?4:3) : 3);
      const taste       = clamp(Math.round((soil_health + safety)/2));
      return { taste, soil_health, environment, safety };
    }

    /**********************
     * ç”»åƒèª­ã¿è¾¼ã¿
     **********************/
    async function loadImagesForFeature(srcUrl, feature){
      // å„ªå…ˆ: props.images â†’ sidecar images.json â†’ æ¨æ¸¬ãƒ‘ã‚¿ãƒ¼ãƒ³
      const props = feature.properties || {};
      let list = [];

      if (Array.isArray(props.images) && props.images.length){
        list = props.images;
      } else if (typeof props.images === "string" && props.images.trim()){
        list = props.images.split(",").map(s => s.trim()).filter(Boolean);
      }

      if (list.length) return absoluteList(list, srcUrl);

      // sidecar images.json
      try{
        const baseDir = srcUrl.substring(0, srcUrl.lastIndexOf("/"));
        const imagesJsonUrl = baseDir + "/images.json";
        const r = await fetch(imagesJsonUrl, {cache:"no-store"});
        if (r.ok){
          const m = await r.json(); // { "F001": ["path", ...], ... }
          const fid = String(props.field_id ?? "");
          if (m && fid && Array.isArray(m[fid])){
            return absoluteList(m[fid], srcUrl);
          }
        }
      }catch{}

      // æ¨æ¸¬ãƒ‘ã‚¿ãƒ¼ãƒ³: <dir>/images/<id>_1..6.(jpg|jpeg|png|webp)
      const dir = srcUrl.substring(0, srcUrl.lastIndexOf("/")) + "/images/";
      const fid = String(props.field_id ?? "");
      const exts = ["jpg","jpeg","png","webp"];
      const tries = [];
      for (let i=1;i<=6;i++){
        for (const e of exts){
          tries.push(`${dir}${fid}_${i}.${e}`);
        }
      }
      // å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼šHEADã§ããªã„ã®ã§ <img> onerror ã§æ¡ã‚Šã¤ã¶ã™æ–¹å¼ï¼ˆã‚®ãƒ£ãƒ©ãƒªãƒ¼å´ã§éè¡¨ç¤ºï¼‰
      return tries;
    }

    function absoluteList(list, srcUrl){
      // list ãŒç›¸å¯¾ãªã‚‰ srcUrl ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è§£æ±º
      const baseDir = srcUrl.substring(0, srcUrl.lastIndexOf("/")) + "/";
      return list.map(u => u.match(/^https?:\/\//) ? u : (u.startsWith("./")||u.startsWith("../")? new URL(u, baseDir).toString() : baseDir + u));
    }

    /**********************
     * ãƒšãƒ¼ã‚¸çŠ¶æ…‹
     **********************/
    const params = new URLSearchParams(location.search);
    const pointId = params.get("id");
    const src = params.get("src") || "data/Saitama/Chichibu/Oota/soil_points.geojson";

    $("idPill").textContent  = `ID: ${pointId ?? "-"}`;
    $("srcPill").textContent = `src: ${src}`;

    // ç”¨é€”ã®ä¿æŒï¼ˆãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã”ã¨ã«è¨˜æ†¶ï¼‰
    const LU_KEY = "soil_landuse:" + src;
    const savedLU = localStorage.getItem(LU_KEY);
    if (savedLU) $("landuse").value = savedLU;

    let featureList = [];
    let currentIndex = -1;
    let radarChart = null;
    let barChart = null;

    main();

    async function main(){
      if(!pointId){
        document.body.innerHTML = `<div class="warn">IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¾‹ï¼š<code>soil.html?id=F001&src=...</code></div>`;
        return;
      }

      let fc;
      try{
        const res = await fetch(src, {cache:"no-store"});
        if(!res.ok) throw new Error(res.status+" "+res.statusText);
        fc = await res.json();
      }catch(e){
        document.body.innerHTML = `<div class="warn">soil_points ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ï¼š<code>${src}</code><br>ã‚¨ãƒ©ãƒ¼ï¼š<code>${String(e)}</code></div>`;
        return;
      }

      featureList = Array.isArray(fc.features) ? fc.features : [];
      currentIndex = featureList.findIndex(f => String(f?.properties?.field_id) === String(pointId));
      if(currentIndex < 0){
        document.body.innerHTML = `<div class="warn">ID <code>${pointId}</code> ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆsrc=${src}ï¼‰ã€‚</div>`;
        return;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆ
      $("prevBtn").onclick = () => {
        if (currentIndex <= 0) return;
        const fid = featureList[currentIndex-1].properties?.field_id;
        location.href = `soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
      };
      $("nextBtn").onclick = () => {
        if (currentIndex >= featureList.length-1) return;
        const fid = featureList[currentIndex+1].properties?.field_id;
        location.href = `soil.html?id=${encodeURIComponent(fid)}&src=${encodeURIComponent(src)}`;
      };
      $("copyLinkBtn").onclick = () => copyText(location.href);

      $("landuse").onchange = () => {
        localStorage.setItem(LU_KEY, $("landuse").value);
        render(featureList[currentIndex]); // å†è©•ä¾¡
      };

      $("applyStdBtn").onclick = () => {
        render(featureList[currentIndex], readCustomStd()); // ç·¨é›†ã—ãŸåŸºæº–ã§å†è©•ä¾¡
      };

      render(featureList[currentIndex]);
    }

    function getStd(){
      const lu = $("landuse").value; // paddy / upland
      return structuredClone(DEFAULT_STANDARDS[lu]);
    }
    function readCustomStd(){
      const s = getStd();
      const ec_ok   = num($("std_ec_ok").value);
      const ec_warn = num($("std_ec_warn").value);
      const ph_ok_lo = num($("std_ph_ok_lo").value);
      const ph_ok_hi = num($("std_ph_ok_hi").value);
      const ph_warn_lo = num($("std_ph_warn_lo").value);
      const ph_warn_hi = num($("std_ph_warn_hi").value);
      const cec_ok  = num($("std_cec_ok").value);
      const cec_warn= num($("std_cec_warn").value);

      if (Number.isFinite(ec_ok))   s.ec.ok = ec_ok;
      if (Number.isFinite(ec_warn)) s.ec.warn = ec_warn;
      if (Number.isFinite(ph_ok_lo) && Number.isFinite(ph_ok_hi)) s.ph.ok = [ph_ok_lo, ph_ok_hi];
      if (Number.isFinite(ph_warn_lo) && Number.isFinite(ph_warn_hi)) s.ph.warn = [ph_warn_lo, ph_warn_hi];
      if (Number.isFinite(cec_ok))   s.cec.ok = cec_ok;
      if (Number.isFinite(cec_warn)) s.cec.warn = cec_warn;
      return s;
    }
    function populateStdEditors(std){
      $("std_ec_ok").value = std.ec.ok;
      $("std_ec_warn").value = std.ec.warn;
      $("std_ph_ok_lo").value = std.ph.ok[0];
      $("std_ph_ok_hi").value = std.ph.ok[1];
      $("std_ph_warn_lo").value = std.ph.warn[0];
      $("std_ph_warn_hi").value = std.ph.warn[1];
      $("std_cec_ok").value = std.cec.ok;
      $("std_cec_warn").value = std.cec.warn;
    }

    async function render(f, overrideStd){
      const p = f.properties || {};
      const [lon, lat] = f.geometry?.coordinates || [];

      $("fieldName").textContent = p.field_id || pointId;
      $("location").textContent  = p["å ´æ‰€å"] || "";

      $("kEC").textContent   = p.EC ?? "-";
      $("kpH").textContent   = p.pH ?? "-";
      $("kCEC").textContent  = p.CEC ?? "-";
      $("kDate").textContent = p["æ¡å–æ—¥"] ?? "-";
      $("kCoord").textContent =
        (Number.isFinite(lat) && Number.isFinite(lon)) ? `${lat.toFixed(6)}, ${lon.toFixed(6)}` : "-";

      $("copyCoordBtn").onclick = () => {
        if (Number.isFinite(lat) && Number.isFinite(lon)) copyText(`${lat.toFixed(6)}, ${lon.toFixed(6)}`);
        else alert("åº§æ¨™ãŒã‚ã‚Šã¾ã›ã‚“");
      };
      $("downloadJsonBtn").onclick = () => downloadBlob(`soil_${p.field_id || pointId}.json`, JSON.stringify(p, null, 2), "application/json");
      $("downloadCsvBtn").onclick  = () => downloadBlob(`soil_${p.field_id || pointId}.csv`, jsonToCsvRow(p), "text/csv");

      // ä¸€è¨€ï¼ˆè‡ªå‹•ï¼‰
      const auto = (() => {
        const ec = num(p.EC); const ph = num(p.pH); const cec = num(p.CEC);
        let msg = "æ¸¬å®šå€¤ã«åŸºã¥ãç®¡ç†æ–¹é‡ã‚’æ¤œè¨ã§ãã¾ã™ã€‚";
        if(Number.isFinite(ec) && ec < 0.10) msg = "ECãŒä½ã‚ï¼šæ–½è‚¥ãƒ»æœ‰æ©Ÿç‰©ç®¡ç†ã®æ¤œè¨ãŒæœ‰åŠ¹ã€‚";
        if(Number.isFinite(ph) && (ph < 5.5 || ph > 7.5)) msg = "pHãŒé©æ­£åŸŸå¤–ï¼šçŸ¯æ­£è³‡æã®æ¤œè¨ãŒæœ‰åŠ¹ã€‚";
        if(Number.isFinite(cec) && cec < 10) msg = "CECãŒä½ã‚ï¼šä¿è‚¥åŠ›å‘ä¸Šï¼ˆæœ‰æ©Ÿç‰©æŠ•å…¥ç­‰ï¼‰ãŒæœ‰åŠ¹ã€‚";
        return msg;
      })();

      const memoKey = `soilMemo:${src}#${p.field_id || pointId}`;
      const memo = loadMemo(memoKey);
      const fixedDesc = memo.fixedDesc ?? p["å›ºå®šèª¬æ˜"] ?? "";
      const evalTxt   = memo.evalTxt   ?? p["è©•ä¾¡"] ?? "";
      const issue     = memo.issue     ?? p["ä¸»ãªèª²é¡Œ"] ?? "";
      const solution  = memo.solution  ?? p["æ”¹å–„ç­–"] ?? "";

      $("oneLine").textContent = issue ? `ä¸»ãªèª²é¡Œï¼š${issue}` : auto;
      $("fixedDescView").textContent = fixedDesc || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("evalView").textContent      = evalTxt   || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("issueView").textContent     = issue     || "ï¼ˆæœªå…¥åŠ›ï¼‰";
      $("solutionView").textContent  = solution  || "ï¼ˆæœªå…¥åŠ›ï¼‰";

      $("fixedDescInput").value = fixedDesc;
      $("evalInput").value      = evalTxt;
      $("issueInput").value     = issue;
      $("solutionInput").value  = solution;

      const editToggle = $("editToggle");
      const saveBtn = $("saveBtn");
      const memoEdit = $("memoEdit");
      let editing = false;
      editToggle.onclick = () => {
        editing = !editing;
        memoEdit.style.display = editing ? "block" : "none";
        saveBtn.style.display  = editing ? "inline-block" : "none";
        editToggle.textContent = editing ? "é–²è¦§" : "ç·¨é›†";
      };
      saveBtn.onclick = () => {
        const newMemo = {
          fixedDesc: $("fixedDescInput").value,
          evalTxt:   $("evalInput").value,
          issue:     $("issueInput").value,
          solution:  $("solutionInput").value
        };
        saveMemo(memoKey, newMemo);
        render(f, overrideStd);
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼‰");
      };

      // åŸºæº–ãƒ»è©•ä¾¡
      const std = overrideStd || getStd();
      populateStdEditors(std);

      const evEC  = evaluateValue(num(p.EC),  std.ec,  "ec");
      const evPH  = evaluateValue(num(p.pH),  std.ph,  "ph");
      const evCEC = evaluateValue(num(p.CEC), std.cec, "cec");

      // ãƒ©ãƒ³ã‚¯ï¼ˆECãƒ™ãƒ¼ã‚¹ã®ç°¡æ˜“ï¼‰
      const rank = calcRankByEC(num(p.EC), std);
      const rankBadge = $("rankBadge");
      rankBadge.textContent = `${rank}ãƒ©ãƒ³ã‚¯ï¼ˆä»®ï¼‰`;
      rankBadge.style.background = rankColor(rank);

      // è¡¨
      const tbody = $("evalTable").querySelector("tbody");
      tbody.innerHTML = "";
      addEvalRow(tbody, "EC (dS/m)", p.EC,  evEC.rangeText,  evEC);
      addEvalRow(tbody, "pH",        p.pH,  evPH.rangeText,  evPH);
      addEvalRow(tbody, "CEC",       p.CEC, evCEC.rangeText, evCEC);

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒ»æ£’
      const scores = scoreRadar(p);
      if (radarChart) radarChart.destroy();
      radarChart = new Chart($("radarChart"), {
        type:"radar",
        data:{ labels:["ãŠã„ã—ã•","åœŸå£Œã®å¥å…¨æ€§","ç’°å¢ƒé…æ…®","å®‰å…¨æ€§"],
          datasets:[{ data:[scores.taste, scores.soil_health, scores.environment, scores.safety],
            fill:true, backgroundColor: rankColor(rank, 0.25), borderColor: rankColor(rank, 1),
            pointBackgroundColor: rankColor(rank, 1) }]},
        options:{ scales:{ r:{ min:0,max:5,ticks:{display:false,stepSize:1} } }, plugins:{ legend:{display:false} } }
      });

      if (barChart) barChart.destroy();
      barChart = new Chart($("barChart"), {
        type:"bar",
        data:{ labels:["EC","pH","CEC"],
          datasets:[{ label:"å€¤", data:[ num(p.EC)||0, num(p.pH)||0, num(p.CEC)||0 ],
          backgroundColor:["#4fc3f7","#81c784","#ffb74d"] }] },
        options:{ plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
      });

      // å…¨å±æ€§
      const wrap = $("analysisWrap"); wrap.innerHTML = ""; wrap.appendChild(renderPropsTable(p));

      // ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼
      const gallery = $("gallery"); gallery.innerHTML = "";
      const imgs = await loadImagesForFeature(src, f);
      let shown = 0;
      const note = $("galleryNote");
      note.textContent = "";

      if (imgs.length === 0){
        note.textContent = "ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚props.images / images.json / images/<ID>_*.jpg ã‚’ã”ç”¨æ„ãã ã•ã„ã€‚";
      }else{
        imgs.forEach(u => {
          const img = document.createElement("img");
          img.loading = "lazy";
          img.alt = p.field_id || "";
          img.src = u;
          img.onerror = () => { img.style.display = "none"; };
          img.onclick = () => window.open(u, "_blank", "noopener");
          img.onload  = () => { shown++; };
          gallery.appendChild(img);
        });
        // å°‘ã—å¾…ã£ã¦ã‚‚ä¸€æšã‚‚è¡¨ç¤ºã•ã‚Œãªã‘ã‚Œã°æ³¨æ„æ›¸ã
        setTimeout(() => {
          if (shown === 0) {
            note.textContent = "ç”»åƒã®URLã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚„æ‹¡å¼µå­ã‚’ã”ç¢ºèªãã ã•ã„ã€‚";
          }
        }, 800);
      }
    }

    function addEvalRow(tbody, label, value, stdText, ev){
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.textContent = label;
      const td2 = document.createElement("td"); td2.textContent = (value ?? "â€”");
      const td3 = document.createElement("td"); td3.textContent = stdText;
      const td4 = document.createElement("td");
      const chip = document.createElement("span");
      chip.className = "chip " + (ev.class||"");
      chip.textContent = ev.label;
      td4.appendChild(chip);
      const td5 = document.createElement("td"); td5.textContent = ev.comment || "";
      tr.append(td1,td2,td3,td4,td5);
      tbody.appendChild(tr);
    }
  </script>
</body>
</html>