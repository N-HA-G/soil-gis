<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>åœŸå£Œè¨ºæ–­çµæœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; line-height: 1.7; padding: 16px; max-width: 800px; margin: 0 auto; }
    .badge {
      display: inline-block;
      color: white;
      padding: 4px 12px;
      border-radius: 4px;
      margin-right: 6px;
      font-weight: bold;
      font-size: 14px;
    }
    .stars { color: #ff9800; }
    details { margin-top: 12px; background: #f9f9f9; padding: 10px; border-radius: 8px; }
    canvas { max-width: 100%; margin: 20px auto; display: block; }
    .topbar { display:flex; gap:10px; align-items:center; margin-bottom:12px; }
    .topbar a { text-decoration:none; color:#0a66c2; }
    .warn { background:#fff3cd; border:1px solid #ffeeba; padding:10px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="topbar">
    ./index.htmlâ† åœ°å›³ã¸æˆ»ã‚‹</a>
  </div>

  <h1 id="fieldName"></h1>
  <p id="location"></p>

  <div>
    <span class="badge" id="rank"></span>
    <span class="badge" style="background:#4caf50;">åœŸå£Œè¨ºæ–­æ¸ˆã¿</span>
  </div>

  <p id="oneLine" style="font-weight:bold; margin-top:1em;"></p>

  <h2>ğŸŒ± ãƒ–ãƒ©ãƒ³ãƒ‰è©•ä¾¡</h2>
  <canvas id="radarChart" width="400" height="400"></canvas>

  <ul>
    <li>ğŸš ãŠã„ã—ã•ï¼š<span class="stars" id="taste"></span></li>
    <li>ğŸŒ± åœŸå£Œã®å¥å…¨æ€§ï¼š<span class="stars" id="soilHealth"></span></li>
    <li>ğŸŒ ç’°å¢ƒé…æ…®ï¼š<span class="stars" id="environment"></span></li>
    <li>ğŸ›¡ å®‰å…¨æ€§ï¼š<span class="stars" id="safety"></span></li>
  </ul>

  <h2>ğŸ“– åœŸå£Œã‚¹ãƒˆãƒ¼ãƒªãƒ¼</h2>
  <img id="storyImage" src="" style="max-width:100%; border-radius:8px; display:none; margin-bottom:10px;">
  <p id="story"></p>

  <details>
    <summary>ğŸ”¬ å°‚é–€ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹</summary>
    <ul id="analysis"></ul>
  </details>

  <h2>ğŸŒ¾ ã“ã®åœŸå£Œã§è‚²ã£ãŸãŠç±³</h2>
  <ul id="rice"></ul>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // ãƒ©ãƒ³ã‚¯åˆ¥ã‚«ãƒ©ãƒ¼åˆ¤å®šé–¢æ•°
    function rankColor(rank, alpha = 1) {
      switch (rank) {
        case "A": return `rgba(76, 175, 80, ${alpha})`;   // ç·‘
        case "B": return `rgba(255, 193, 7, ${alpha})`;   // é»„
        case "C": return `rgba(244, 67, 54, ${alpha})`;   // èµ¤
        default:  return `rgba(158, 158, 158, ${alpha})`; // ã‚°ãƒ¬ãƒ¼
      }
    }

    const params = new URLSearchParams(location.search);
    const soilId = params.get("id"); // ä¾‹: F001

    if (!soilId) {
      document.body.innerHTML = '<div class="warn">IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚åœ°å›³ã‹ã‚‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</div>';
      throw new Error("id is missing");
    }

    // â˜… GitHub Pages ã§ã‚‚ç¢ºå®Ÿã«èª­ã‚ã‚‹ã‚ˆã†ã«ç›¸å¯¾ãƒ‘ã‚¹ã‚’å›ºå®š
    Promise.all([
      fetch("./data/diagnosis/soil.json", { cache: "no-store" }).then(res => res.json()),
      fetch("./data/diagnosis/rice.json", { cache: "no-store" }).then(res => res.json())
    ]).then(([soils, riceList]) => {
      const soil = soils.find(s => s.soil_id === soilId);
      if (!soil) {
        document.body.innerHTML = `<div class="warn">è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆid=${soilId}ï¼‰ã€‚<br>data/diagnosis/soil.json ã« soil_id="${soilId}" ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>`;
        return;
      }

      // ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±
      document.getElementById("fieldName").textContent = soil.name ?? soil.soil_id;
      document.getElementById("location").textContent = soil.location ?? "";
      document.getElementById("oneLine").textContent = soil.one_line ?? "";
      document.getElementById("story").textContent = soil.story ?? "";

      // å†™çœŸï¼ˆã‚ã‚Œã°ï¼‰
      const storyImg = document.getElementById("storyImage");
      if (soil.story_image) {
        storyImg.src = soil.story_image;
        storyImg.style.display = "block";
      } else {
        storyImg.style.display = "none";
      }

      // ãƒ©ãƒ³ã‚¯ãƒãƒƒã‚¸
      const rankBadge = document.getElementById("rank");
      rankBadge.textContent = (soil.rank ?? "â€”") + "ãƒ©ãƒ³ã‚¯";
      rankBadge.style.backgroundColor = rankColor(soil.rank);

      // æ˜Ÿè©•ä¾¡
      const star = n => "â˜…".repeat(n) + "â˜†".repeat(5 - n);
      const scores = soil.brand_scores ?? { taste:0, soil_health:0, environment:0, safety:0 };
      document.getElementById("taste").textContent = star(scores.taste ?? 0);
      document.getElementById("soilHealth").textContent = star(scores.soil_health ?? 0);
      document.getElementById("environment").textContent = star(scores.environment ?? 0);
      document.getElementById("safety").textContent = star(scores.safety ?? 0);

      // ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
      const ctx = document.getElementById("radarChart");
      const mainColor = rankColor(soil.rank, 1);
      const fillColor = rankColor(soil.rank, 0.25);

      new Chart(ctx, {
        type: "radar",
        data: {
          labels: ["ãŠã„ã—ã•", "åœŸå£Œã®å¥å…¨æ€§", "ç’°å¢ƒé…æ…®", "å®‰å…¨æ€§"],
          datasets: [{
            label: "åœŸå£Œè¨ºæ–­è©•ä¾¡",
            data: [scores.taste, scores.soil_health, scores.environment, scores.safety],
            fill: true,
            backgroundColor: fillColor,
            borderColor: mainColor,
            pointBackgroundColor: mainColor
          }]
        },
        options: {
          scales: {
            r: {
              min: 0,
              max: 5,
              ticks: { display: false, stepSize: 1 },
              pointLabels: { font: { size: 14 } }
            }
          },
          plugins: { legend: { display: false } }
        }
      });

      // å°‚é–€ãƒ‡ãƒ¼ã‚¿
      const analysis = document.getElementById("analysis");
      const a = soil.analysis ?? {};
      Object.entries(a).forEach(([k, v]) => {
        const li = document.createElement("li");
        li.textContent = `${k}ï¼š${v}`;
        analysis.appendChild(li);
      });

      // ãŠç±³æƒ…å ±
      const rice = riceList.find(r => r.product_id === soil.linked_rice);
      if (rice) {
        const ul = document.getElementById("rice");
        (rice.taste ?? []).forEach(t => {
          const li = document.createElement("li");
          li.textContent = t;
          ul.appendChild(li);
        });
      }
    });
  </script>
</body>
</html>
